<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DccHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pircbotx</a> &gt; <a href="index.source.html" class="el_package">org.pircbotx.dcc</a> &gt; <span class="el_source">DccHandler.java</span></div><h1>DccHandler.java</h1><pre class="source lang-java linenums">// Generated by delombok at Sun Jan 24 05:08:02 EST 2016
/**
 * Copyright (C) 2010-2014 Leon Blakey &lt;lord.quackstar at gmail.com&gt;
 *
 * This file is part of PircBotX.
 *
 * PircBotX is free software: you can redistribute it and/or modify it under the
 * terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 *
 * PircBotX is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * PircBotX. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.pircbotx.dcc;

import java.io.Closeable;
import java.io.File;
import java.io.IOException;
import java.math.BigInteger;
import java.net.InetAddress;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.UnknownHostException;
import java.security.SecureRandom;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;
import org.pircbotx.Configuration;
import org.pircbotx.PircBotX;
import org.pircbotx.User;
import org.pircbotx.Utils;
import org.pircbotx.exception.DccException;
import org.pircbotx.hooks.events.IncomingChatRequestEvent;
import org.pircbotx.hooks.events.IncomingFileTransferEvent;
import static com.google.common.base.Preconditions.*;
import com.google.common.collect.ImmutableList;
import java.net.Inet4Address;
import java.net.Inet6Address;
import lombok.NonNull;
import org.pircbotx.UserHostmask;

/**
 * Handler of all DCC requests
 * &lt;p&gt;
 * @author Leon Blakey
 */
public class DccHandler implements Closeable {
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
<span class="fc" id="L61">	private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(DccHandler.class);</span>
<span class="fc" id="L62">	protected static final Random TOKEN_RANDOM = new SecureRandom();</span>
	protected static final int TOKEN_RANDOM_MAX = 20000;
	@NonNull
	protected final PircBotX bot;
<span class="fc" id="L66">	protected final Map&lt;PendingRecieveFileTransfer, CountDownLatch&gt; pendingReceiveTransfers = new HashMap&lt;PendingRecieveFileTransfer, CountDownLatch&gt;();</span>
<span class="fc" id="L67">	protected final List&lt;PendingSendFileTransfer&gt; pendingSendTransfers = new ArrayList&lt;PendingSendFileTransfer&gt;();</span>
<span class="fc" id="L68">	protected final Map&lt;PendingSendFileTransferPassive, CountDownLatch&gt; pendingSendPassiveTransfers = new HashMap&lt;PendingSendFileTransferPassive, CountDownLatch&gt;();</span>
<span class="fc" id="L69">	protected final Map&lt;PendingSendChatPassive, CountDownLatch&gt; pendingSendPassiveChat = new HashMap&lt;PendingSendChatPassive, CountDownLatch&gt;();</span>
<span class="fc" id="L70">	protected boolean shuttingDown = false;</span>
	
	public boolean processDcc(UserHostmask userHostmask, final User user, String request) throws IOException {
<span class="fc" id="L73">		List&lt;String&gt; requestParts = tokenizeDccRequest(request);</span>
<span class="fc" id="L74">		String type = requestParts.get(1);</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">		if (type.equals(&quot;SEND&quot;)) {</span>
			//Someone is trying to send a file to us
			//Example: DCC SEND &lt;filename&gt;  &lt;ip&gt; &lt;port&gt; &lt;file size&gt; &lt;transferToken&gt; (note File size is optional)
<span class="fc" id="L78">			String rawFilename = requestParts.get(2);</span>
<span class="pc bpc" id="L79" title="3 of 4 branches missed.">			final String safeFilename = (rawFilename.startsWith(&quot;\&quot;&quot;) &amp;&amp; rawFilename.endsWith(&quot;\&quot;&quot;)) ? rawFilename.substring(1, rawFilename.length() - 1) : rawFilename;</span>
<span class="fc" id="L80">			InetAddress address = parseRawAddress(requestParts.get(3));</span>
<span class="fc" id="L81">			int port = Integer.parseInt(requestParts.get(4));</span>
<span class="fc" id="L82">			long size = Long.parseLong(Utils.tryGetIndex(requestParts, 5, &quot;-1&quot;));</span>
<span class="fc" id="L83">			String transferToken = Utils.tryGetIndex(requestParts, 6, null);</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">			if (transferToken != null) </span>
			//Check if this is an acknowledgement of a passive dcc file request
<span class="fc" id="L86">			synchronized (pendingSendPassiveTransfers) {</span>
<span class="fc" id="L87">				Iterator&lt;Map.Entry&lt;PendingSendFileTransferPassive, CountDownLatch&gt;&gt; pendingItr = pendingSendPassiveTransfers.entrySet().iterator();</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">				while (pendingItr.hasNext()) {</span>
<span class="nc" id="L89">					Map.Entry&lt;PendingSendFileTransferPassive, CountDownLatch&gt; curEntry = pendingItr.next();</span>
<span class="nc" id="L90">					PendingSendFileTransferPassive transfer = curEntry.getKey();</span>
<span class="nc bnc" id="L91" title="All 6 branches missed.">					if (transfer.getUser() == user &amp;&amp; transfer.getFilename().equals(rawFilename) &amp;&amp; transfer.getTransferToken().equals(transferToken)) {</span>
<span class="nc" id="L92">						transfer.setReceiverAddress(address);</span>
<span class="nc" id="L93">						transfer.setReceiverPort(port);</span>
<span class="nc" id="L94">						log.debug(&quot;Passive send file transfer of file {} to user {} accepted at address {} and port {}&quot;, transfer.getFilename(), transfer.getUser().getNick(), address, port);</span>
<span class="nc" id="L95">						curEntry.getValue().countDown();</span>
<span class="nc" id="L96">						pendingItr.remove();</span>
<span class="nc" id="L97">						return true;</span>
					}
<span class="nc" id="L99">				}</span>
<span class="pc" id="L100">			}</span>
			//Nope, this is a new transfer
<span class="pc bpc" id="L102" title="1 of 4 branches missed.">			if (port == 0 || transferToken != null) </span>
			//User is trying to use reverse DCC
<span class="fc" id="L104">			bot.getConfiguration().getListenerManager().onEvent(new IncomingFileTransferEvent(bot, userHostmask, user, rawFilename, safeFilename, address, port, size, transferToken, true)); else bot.getConfiguration().getListenerManager().onEvent(new IncomingFileTransferEvent(bot, userHostmask, user, rawFilename, safeFilename, address, port, size, transferToken, false));</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">		} else if (type.equals(&quot;RESUME&quot;)) {</span>
			//Someone is trying to resume sending a file to us
			//Example: DCC RESUME &lt;filename&gt; 0 &lt;position&gt; &lt;token&gt;
			//Reply with: DCC ACCEPT &lt;filename&gt; 0 &lt;position&gt; &lt;token&gt;
<span class="nc" id="L109">			String filename = requestParts.get(2);</span>
<span class="nc" id="L110">			int port = Integer.parseInt(requestParts.get(3));</span>
<span class="nc" id="L111">			long position = Long.parseLong(requestParts.get(4));</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">			if (port == 0) {</span>
				//Passive transfer
<span class="nc" id="L114">				String transferToken = requestParts.get(5);</span>
<span class="nc" id="L115">				synchronized (pendingSendPassiveTransfers) {</span>
<span class="nc" id="L116">					Iterator&lt;Map.Entry&lt;PendingSendFileTransferPassive, CountDownLatch&gt;&gt; pendingItr = pendingSendPassiveTransfers.entrySet().iterator();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">					while (pendingItr.hasNext()) {</span>
<span class="nc" id="L118">						Map.Entry&lt;PendingSendFileTransferPassive, CountDownLatch&gt; curEntry = pendingItr.next();</span>
<span class="nc" id="L119">						PendingSendFileTransferPassive transfer = curEntry.getKey();</span>
<span class="nc bnc" id="L120" title="All 6 branches missed.">						if (transfer.getUser() == user &amp;&amp; transfer.getFilename().equals(filename) &amp;&amp; transfer.getTransferToken().equals(transferToken)) {</span>
<span class="nc" id="L121">							transfer.setStartPosition(position);</span>
<span class="nc" id="L122">							log.debug(&quot;Passive send file transfer of file {} to user {} set to position {}&quot;, transfer.getFilename(), transfer.getUser().getNick(), position);</span>
<span class="nc" id="L123">							return true;</span>
						}
<span class="nc" id="L125">					}</span>
<span class="nc" id="L126">				}</span>
<span class="nc" id="L127">			} else synchronized (pendingSendTransfers) {</span>
<span class="nc" id="L128">				Iterator&lt;PendingSendFileTransfer&gt; pendingItr = pendingSendTransfers.iterator();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">				while (pendingItr.hasNext()) {</span>
<span class="nc" id="L130">					PendingSendFileTransfer transfer = pendingItr.next();</span>
<span class="nc bnc" id="L131" title="All 6 branches missed.">					if (transfer.getUser() == user &amp;&amp; transfer.getFilename().equals(filename) &amp;&amp; transfer.getPort() == port) {</span>
<span class="nc" id="L132">						transfer.setPosition(position);</span>
<span class="nc" id="L133">						log.debug(&quot;Send file transfer of file {} to user {} set to position {}&quot;, transfer.getFilename(), transfer.getUser().getNick(), position);</span>
<span class="nc" id="L134">						return true;</span>
					}
<span class="nc" id="L136">				}</span>
<span class="nc" id="L137">			}</span>
			//Haven't returned yet, received an unknown transfer
<span class="nc" id="L139">			throw new DccException(DccException.Reason.UnknownFileTransferResume, user, &quot;Transfer line: &quot; + request);</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">		} else if (type.equals(&quot;ACCEPT&quot;)) {</span>
			//Someone is acknowledging a transfer resume
			//Example (normal):  DCC ACCEPT &lt;filename&gt; &lt;port&gt; &lt;position&gt;
			//Example (passive): DCC ACCEPT &lt;filename&gt; 0 &lt;position&gt; &lt;token&gt;
			//TODO how well does this handle non passive?
<span class="nc" id="L145">			String filename = requestParts.get(2);</span>
			int port;
<span class="nc" id="L147">			long position = Long.parseLong(requestParts.get(4));</span>
			String transferToken;
<span class="nc bnc" id="L149" title="All 2 branches missed.">			if (requestParts.size() == 5) {</span>
				//Standard request
<span class="nc" id="L151">				port = Integer.parseInt(requestParts.get(3));</span>
<span class="nc" id="L152">				transferToken = null;</span>
			} else {
				//Passive request
<span class="nc" id="L155">				port = 0;</span>
<span class="nc" id="L156">				transferToken = requestParts.get(5);</span>
			}
<span class="nc" id="L158">			synchronized (pendingReceiveTransfers) {</span>
<span class="nc" id="L159">				Iterator&lt;Map.Entry&lt;PendingRecieveFileTransfer, CountDownLatch&gt;&gt; pendingItr = pendingReceiveTransfers.entrySet().iterator();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">				while (pendingItr.hasNext()) {</span>
<span class="nc" id="L161">					Map.Entry&lt;PendingRecieveFileTransfer, CountDownLatch&gt; curEntry = pendingItr.next();</span>
<span class="nc" id="L162">					IncomingFileTransferEvent transferEvent = curEntry.getKey().getEvent();</span>
<span class="nc bnc" id="L163" title="All 8 branches missed.">					if (transferEvent.getUser() == user &amp;&amp; transferEvent.getRawFilename().equals(filename) &amp;&amp; transferEvent.getPort() == port &amp;&amp; transferEvent.getToken().equals(transferToken)) {</span>
<span class="nc" id="L164">						curEntry.getKey().setPosition(position);</span>
<span class="nc" id="L165">						log.debug(&quot;Receive file transfer of file {} to user {} set to position {}&quot;, transferEvent.getRawFilename(), transferEvent.getUser().getNick(), position);</span>
<span class="nc" id="L166">						curEntry.getValue().countDown();</span>
<span class="nc" id="L167">						pendingItr.remove();</span>
<span class="nc" id="L168">						return true;</span>
					}
<span class="nc" id="L170">				}</span>
<span class="nc" id="L171">			}</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">		} else if (type.equals(&quot;CHAT&quot;)) {</span>
			//Someone is trying to chat with us
			//Example: DCC CHAT &lt;protocol&gt; &lt;ip&gt; &lt;port&gt; (protocol should be chat)
<span class="fc" id="L175">			InetAddress address = parseRawAddress(requestParts.get(3));</span>
<span class="fc" id="L176">			int port = Integer.parseInt(requestParts.get(4));</span>
<span class="fc" id="L177">			String chatToken = Utils.tryGetIndex(requestParts, 5, null);</span>
			//Check if this is an acknowledgement of a passive chat request
<span class="fc bfc" id="L179" title="All 2 branches covered.">			if (chatToken != null) synchronized (pendingSendPassiveChat) {</span>
<span class="fc" id="L180">				Iterator&lt;Map.Entry&lt;PendingSendChatPassive, CountDownLatch&gt;&gt; pendingItr = pendingSendPassiveChat.entrySet().iterator();</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">				while (pendingItr.hasNext()) {</span>
<span class="nc" id="L182">					Map.Entry&lt;PendingSendChatPassive, CountDownLatch&gt; curEntry = pendingItr.next();</span>
<span class="nc" id="L183">					PendingSendChatPassive pendingChat = curEntry.getKey();</span>
<span class="nc" id="L184">					log.trace(&quot;Current pending chat: {}&quot;, pendingChat);</span>
<span class="nc bnc" id="L185" title="All 4 branches missed.">					if (pendingChat.getUser() == user &amp;&amp; pendingChat.getChatToken().equals(chatToken)) {</span>
<span class="nc" id="L186">						log.debug(&quot;Passive chat request to user {} accepted&quot;, user);</span>
<span class="nc" id="L187">						pendingChat.setReceiverAddress(address);</span>
<span class="nc" id="L188">						pendingChat.setReceiverPort(port);</span>
<span class="nc" id="L189">						curEntry.getValue().countDown();</span>
<span class="nc" id="L190">						pendingItr.remove();</span>
<span class="nc" id="L191">						return true;</span>
					}
<span class="nc" id="L193">				}</span>
<span class="pc" id="L194">			}</span>
			//Nope, this is a new chat
<span class="pc bpc" id="L196" title="3 of 4 branches missed.">			if (port == 0 &amp;&amp; chatToken != null) bot.getConfiguration().getListenerManager().onEvent(new IncomingChatRequestEvent(bot, userHostmask, user, address, port, chatToken, true)); else bot.getConfiguration().getListenerManager().onEvent(new IncomingChatRequestEvent(bot, userHostmask, user, address, port, chatToken, false));</span>
<span class="pc" id="L197">		} else return false;</span>
<span class="fc" id="L198">		return true;</span>
	}
	
	/**
	 * Accept chat request, blocking until the connection is active
	 * &lt;p&gt;
	 * @param event The chat request event
	 * @return An active {@link ReceiveChat}
	 * @throws IOException If an error occurred during connection
	 */
	public ReceiveChat acceptChatRequest(IncomingChatRequestEvent event) throws IOException {
<span class="nc" id="L209">		checkNotNull(event, &quot;Event cannot be null&quot;);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">		if (event.isPassive()) {</span>
<span class="nc" id="L211">			ServerSocket serverSocket = createServerSocket(event.getUser());</span>
<span class="nc" id="L212">			InetAddress publicAddress = getRealDccPublicAddress(serverSocket);</span>
<span class="nc" id="L213">			bot.sendDCC().chatPassiveAccept(event.getUser().getNick(), publicAddress, serverSocket.getLocalPort(), event.getToken());</span>
<span class="nc" id="L214">			log.debug(&quot;Sent DCC recieve chat accept to user {} ({}ms timeout) to passive connect on public address {}, local address {}&quot;, event.getUser().getNick(), bot.getConfiguration().getDccAcceptTimeout(), publicAddress, serverSocket.getLocalSocketAddress());</span>
<span class="nc" id="L215">			Socket userSocket = serverSocket.accept();</span>
			//User is connected, begin transfer
<span class="nc" id="L217">			serverSocket.close();</span>
<span class="nc" id="L218">			return bot.getConfiguration().getBotFactory().createReceiveChat(bot, event.getUser(), userSocket);</span>
		} else {
<span class="nc" id="L220">			InetAddress localAddress = getRealDccLocalAddress(event.getAddress());</span>
<span class="nc" id="L221">			log.debug(&quot;Accepting DCC recieve chat from user {} at address {} port {} from local address {}&quot;, event.getUser().getNick(), event.getAddress(), event.getPort(), localAddress);</span>
<span class="nc" id="L222">			return bot.getConfiguration().getBotFactory().createReceiveChat(bot, event.getUser(), new Socket(event.getAddress(), event.getPort(), localAddress, 0));</span>
		}
	}
	
	/**
	 * Accept file transfer at position 0, blocking until the connection is
	 * active
	 * &lt;p&gt;
	 * @param event The file request event
	 * @param destination The destination file
	 * @return An active {@link ReceiveFileTransfer}
	 * @throws IOException If an error occurred during connection
	 */
	public ReceiveFileTransfer acceptFileTransfer(IncomingFileTransferEvent event, File destination) throws IOException {
<span class="nc" id="L236">		checkNotNull(event, &quot;Event cannot be null&quot;);</span>
<span class="nc" id="L237">		checkNotNull(destination, &quot;Destination file cannot be null&quot;);</span>
<span class="nc" id="L238">		return acceptFileTransfer(event, destination, 0);</span>
	}
	
	/**
	 * Accept file transfer resuming at specified position, blocking until the
	 * connection is active
	 * &lt;p&gt;
	 * @param event The file request event
	 * @param destination The destination file
	 * @param startPosition The position to start the transfer at
	 * @return An active {@link ReceiveFileTransfer}
	 * @throws IOException If an error occurred during connection
	 * @throws InterruptedException If this is interrupted while waiting for a
	 * connection
	 * @throws DccException If a timeout is reached or the bot is shutting down
	 */
	public ReceiveFileTransfer acceptFileTransferResume(IncomingFileTransferEvent event, File destination, long startPosition) throws IOException, InterruptedException, DccException {
<span class="nc" id="L255">		checkNotNull(event, &quot;Event cannot be null&quot;);</span>
<span class="nc" id="L256">		checkNotNull(destination, &quot;Destination file cannot be null&quot;);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">		checkArgument(startPosition &gt;= 0, &quot;Start position %s must be positive&quot;, startPosition);</span>
		//Add to pending map so we can be notified when the user has accepted
<span class="nc" id="L259">		CountDownLatch countdown = new CountDownLatch(1);</span>
<span class="nc" id="L260">		PendingRecieveFileTransfer pendingTransfer = new PendingRecieveFileTransfer(event);</span>
<span class="nc" id="L261">		synchronized (pendingReceiveTransfers) {</span>
<span class="nc" id="L262">			pendingReceiveTransfers.put(pendingTransfer, countdown);</span>
<span class="nc" id="L263">		}</span>
		//Tell user were going to resume transfering
<span class="nc bnc" id="L265" title="All 2 branches missed.">		if (event.isPassive()) bot.sendDCC().filePassiveResumeRequest(event.getUser().getNick(), event.getRawFilename(), startPosition, event.getToken()); else bot.sendDCC().fileResumeRequest(event.getUser().getNick(), event.getRawFilename(), event.getPort(), startPosition);</span>
		//Wait for response
<span class="nc bnc" id="L267" title="All 2 branches missed.">		if (!countdown.await(bot.getConfiguration().getDccResumeAcceptTimeout(), TimeUnit.MILLISECONDS)) throw new DccException(DccException.Reason.FileTransferResumeTimeout, event.getUser(), &quot;Event: &quot; + event);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (shuttingDown) throw new DccException(DccException.Reason.FileTransferResumeCancelled, event.getUser(), &quot;Transfer &quot; + event + &quot; canceled due to bot shutting down&quot;);</span>
		//User has accepted resume, begin transfer
<span class="nc bnc" id="L270" title="All 2 branches missed.">		if (pendingTransfer.getPosition() != startPosition) log.warn(&quot;User is resuming transfer at position {} instead of requested position {} for transfer {}. Defaulting to users position&quot;, pendingTransfer.getPosition(), startPosition, event);</span>
<span class="nc" id="L271">		return acceptFileTransfer(event, destination, pendingTransfer.getPosition());</span>
	}
	
	protected ReceiveFileTransfer acceptFileTransfer(IncomingFileTransferEvent event, File destination, long startPosition) throws IOException {
<span class="nc" id="L275">		checkNotNull(event, &quot;Event cannot be null&quot;);</span>
<span class="nc" id="L276">		checkNotNull(destination, &quot;Destination file cannot be null&quot;);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">		checkArgument(startPosition &gt;= 0, &quot;Start position %s must be positive&quot;, startPosition);</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">		if (event.isPassive()) {</span>
<span class="nc" id="L279">			ServerSocket serverSocket = createServerSocket(event.getUser());</span>
<span class="nc" id="L280">			bot.sendDCC().filePassiveAccept(event.getUser().getNick(), event.getRawFilename(), getRealDccPublicAddress(serverSocket), serverSocket.getLocalPort(), event.getFilesize(), event.getToken());</span>
<span class="nc" id="L281">			Socket userSocket = serverSocket.accept();</span>
			//User is connected, begin transfer
<span class="nc" id="L283">			serverSocket.close();</span>
<span class="nc" id="L284">			return bot.getConfiguration().getBotFactory().createReceiveFileTransfer(bot, userSocket, event.getUser(), destination, startPosition, event.getFilesize());</span>
		} else {
<span class="nc" id="L286">			Socket userSocket = new Socket(event.getAddress(), event.getPort(), getRealDccLocalAddress(event.getAddress()), 0);</span>
<span class="nc" id="L287">			return bot.getConfiguration().getBotFactory().createReceiveFileTransfer(bot, userSocket, event.getUser(), destination, startPosition, event.getFilesize());</span>
		}
	}
	
	/**
	 * Send a chat request using {@link Configuration#isDccPassiveRequest()}
	 * &lt;p&gt;
	 * @param receiver The user to chat with
	 * @return An active {@link SendChat}
	 * @throws IOException If an error occurred during connection
	 * @throws InterruptedException If passive connection was interrupted
	 * @throws DccException If a timeout is reached or the bot is shutting down
	 */
	public SendChat sendChat(User receiver) throws IOException, InterruptedException {
<span class="nc" id="L301">		return sendChat(receiver, bot.getConfiguration().isDccPassiveRequest());</span>
	}
	
	/**
	 * Send a chat request using passive parameter
	 * &lt;p&gt;
	 * @param receiver The user to chat with
	 * @param passive Whether to connect passively
	 * @return An active {@link SendChat}
	 * @throws IOException If an error occurred during connection
	 * @throws InterruptedException If passive connection was interrupted
	 * @throws DccException If a timeout is reached or the bot is shutting down
	 */
	public SendChat sendChat(User receiver, boolean passive) throws IOException, InterruptedException {
<span class="nc" id="L315">		checkNotNull(receiver, &quot;Receiver user cannot be null&quot;);</span>
<span class="nc" id="L316">		int dccAcceptTimeout = bot.getConfiguration().getDccAcceptTimeout();</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">		if (passive) {</span>
<span class="nc" id="L318">			String chatToken = Integer.toString(TOKEN_RANDOM.nextInt(TOKEN_RANDOM_MAX));</span>
<span class="nc" id="L319">			PendingSendChatPassive pendingChat = new PendingSendChatPassive(receiver, chatToken);</span>
<span class="nc" id="L320">			CountDownLatch countdown = new CountDownLatch(1);</span>
<span class="nc" id="L321">			synchronized (pendingSendPassiveChat) {</span>
<span class="nc" id="L322">				pendingSendPassiveChat.put(pendingChat, countdown);</span>
<span class="nc" id="L323">			}</span>
<span class="nc" id="L324">			InetAddress publicAddress = getRealDccPublicAddress();</span>
<span class="nc" id="L325">			bot.sendDCC().chatPassiveRequest(receiver.getNick(), publicAddress, chatToken);</span>
			//Wait for the user to acknowledge
<span class="nc" id="L327">			log.debug(&quot;Sent DCC send chat request to user {} ({}ms timeout) for passive connect info using public address {}&quot;, receiver.getNick(), bot.getConfiguration().getDccAcceptTimeout(), publicAddress);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">			if (!countdown.await(dccAcceptTimeout, TimeUnit.MILLISECONDS)) throw new DccException(DccException.Reason.ChatTimeout, receiver, &quot;&quot;);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">			if (shuttingDown) throw new DccException(DccException.Reason.ChatCancelled, receiver, &quot;&quot;);</span>
<span class="nc" id="L330">			Socket chatSocket = new Socket(pendingChat.getReceiverAddress(), pendingChat.getReceiverPort());</span>
<span class="nc" id="L331">			return bot.getConfiguration().getBotFactory().createSendChat(bot, receiver, chatSocket);</span>
		} else {
			//Get the user to connect to us
<span class="nc" id="L334">			ServerSocket serverSocket = createServerSocket(receiver);</span>
<span class="nc" id="L335">			InetAddress publicAddress = getRealDccPublicAddress(serverSocket);</span>
<span class="nc" id="L336">			bot.sendDCC().chatRequest(receiver.getNick(), publicAddress, serverSocket.getLocalPort());</span>
			//Wait for user to connect
<span class="nc" id="L338">			log.debug(&quot;Sent DCC send chat request to user {} ({}ms timeout) to connect on public address {}:{}, local address {}&quot;, receiver.getNick(), bot.getConfiguration().getDccAcceptTimeout(), publicAddress, serverSocket.getLocalPort(), serverSocket.getLocalSocketAddress());</span>
<span class="nc" id="L339">			Socket userSocket = serverSocket.accept();</span>
<span class="nc" id="L340">			log.debug(&quot;Recieved connection&quot;);</span>
<span class="nc" id="L341">			serverSocket.close();</span>
<span class="nc" id="L342">			return bot.getConfiguration().getBotFactory().createSendChat(bot, receiver, userSocket);</span>
		}
	}
	
	/**
	 * Send file using {@link Configuration#isDccPassiveRequest() }
	 * &lt;p&gt;
	 * @param file The file to send
	 * @param receiver The user to send the file to
	 * @return An active {@link SendFileTransfer}
	 * @throws IOException If an error occurred during connecting
	 * @throws DccException If a timeout is reached or the bot is shutting down
	 * @throws InterruptedException If passive connection was interrupted
	 */
	public SendFileTransfer sendFile(File file, User receiver) throws IOException, DccException, InterruptedException {
<span class="nc" id="L357">		return sendFile(file, receiver, bot.getConfiguration().isDccPassiveRequest());</span>
	}
	
	/**
	 * Send file using {@link Configuration#isDccPassiveRequest() }
	 * &lt;p&gt;
	 * @param file The file to send
	 * @param receiver The user to send the file to
	 * @param passive Whether to connect passively
	 * @return An active {@link SendFileTransfer}
	 * @throws IOException If an error occurred during connecting
	 * @throws DccException If a timeout is reached or the bot is shutting down
	 * @throws InterruptedException If passive connection was interrupted
	 */
	public SendFileTransfer sendFile(File file, User receiver, boolean passive) throws IOException, DccException, InterruptedException {
<span class="nc" id="L372">		checkNotNull(file, &quot;Source file cannot be null&quot;);</span>
<span class="nc" id="L373">		checkNotNull(receiver, &quot;Receiver cannot be null&quot;);</span>
<span class="nc" id="L374">		checkArgument(file.exists(), &quot;File must exist&quot;);</span>
		//Make the filename safe to send
<span class="nc" id="L376">		String safeFilename = file.getName();</span>
<span class="nc bnc" id="L377" title="All 4 branches missed.">		if (safeFilename.contains(&quot; &quot;)) if (bot.getConfiguration().isDccFilenameQuotes()) safeFilename = &quot;\&quot;&quot; + safeFilename + &quot;\&quot;&quot;; else safeFilename = safeFilename.replace(&quot; &quot;, &quot;_&quot;);</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">		if (passive) {</span>
<span class="nc" id="L379">			String transferToken = Integer.toString(TOKEN_RANDOM.nextInt(TOKEN_RANDOM_MAX));</span>
<span class="nc" id="L380">			CountDownLatch countdown = new CountDownLatch(1);</span>
<span class="nc" id="L381">			PendingSendFileTransferPassive pendingPassiveTransfer = new PendingSendFileTransferPassive(receiver, safeFilename, transferToken);</span>
<span class="nc" id="L382">			synchronized (pendingSendTransfers) {</span>
<span class="nc" id="L383">				pendingSendPassiveTransfers.put(pendingPassiveTransfer, countdown);</span>
<span class="nc" id="L384">			}</span>
<span class="nc" id="L385">			InetAddress publicAddress = getRealDccPublicAddress();</span>
<span class="nc" id="L386">			bot.sendDCC().filePassiveRequest(receiver.getNick(), safeFilename, publicAddress, file.length(), transferToken);</span>
			//Wait for user to acknowledge
<span class="nc" id="L388">			log.debug(&quot;Sent DCC send file request to user {} ({}ms timeout) for passive connect info using public address {} for file {}&quot;, receiver.getNick(), bot.getConfiguration().getDccAcceptTimeout(), publicAddress, file.getAbsolutePath());</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">			if (!countdown.await(bot.getConfiguration().getDccAcceptTimeout(), TimeUnit.MILLISECONDS)) throw new DccException(DccException.Reason.FileTransferTimeout, receiver, &quot;File: &quot; + file.getAbsolutePath());</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">			if (shuttingDown) throw new DccException(DccException.Reason.FileTransferCancelled, receiver, &quot;Transfer of file &quot; + file.getAbsolutePath() + &quot; canceled due to bot shutdown&quot;);</span>
<span class="nc" id="L391">			Socket transferSocket = new Socket(pendingPassiveTransfer.getReceiverAddress(), pendingPassiveTransfer.getReceiverPort());</span>
<span class="nc" id="L392">			return bot.getConfiguration().getBotFactory().createSendFileTransfer(bot, transferSocket, receiver, file, pendingPassiveTransfer.getStartPosition());</span>
		} else {
			//Try to get the user to connect to us
<span class="nc" id="L395">			final ServerSocket serverSocket = createServerSocket(receiver);</span>
<span class="nc" id="L396">			PendingSendFileTransfer pendingSendFileTransfer = new PendingSendFileTransfer(receiver, safeFilename, serverSocket.getLocalPort());</span>
<span class="nc" id="L397">			synchronized (pendingSendTransfers) {</span>
<span class="nc" id="L398">				pendingSendTransfers.add(pendingSendFileTransfer);</span>
<span class="nc" id="L399">			}</span>
<span class="nc" id="L400">			InetAddress publicAddress = getRealDccPublicAddress(serverSocket);</span>
<span class="nc" id="L401">			bot.sendDCC().fileRequest(receiver.getNick(), safeFilename, publicAddress, serverSocket.getLocalPort(), file.length());</span>
			//Wait for the user to connect
<span class="nc" id="L403">			log.debug(&quot;Sent DCC send file request to user {} ({}ms timeout) to connect on public address {}, local address {}, port {} for file {}&quot;, receiver.getNick(), bot.getConfiguration().getDccAcceptTimeout(), publicAddress, serverSocket.getLocalSocketAddress(), serverSocket.getLocalPort(), file.getAbsolutePath());</span>
<span class="nc" id="L404">			Socket userSocket = serverSocket.accept();</span>
<span class="nc" id="L405">			serverSocket.close();</span>
<span class="nc" id="L406">			return bot.getConfiguration().getBotFactory().createSendFileTransfer(bot, userSocket, receiver, file, pendingSendFileTransfer.getPosition());</span>
		}
	}
	
	/**
	 * Try to get a real InetAddress in this order:
	 * &lt;ol&gt;
	 * &lt;li&gt;{@link Configuration#getDccLocalAddress()}&lt;/li&gt;
	 * &lt;li&gt;{@link Configuration#getLocalAddress()}&lt;/li&gt;
	 * &lt;li&gt;{@link PircBotX#getLocalAddress()}&lt;/li&gt;
	 * &lt;/ol&gt;
	 */
	public InetAddress getRealDccLocalAddress(InetAddress destAddress) {
		//Issue #268: Workaround to give IPv6 users an IPv6 address, or return null to let the OS figure it out
<span class="nc" id="L420">		InetAddress address = bot.getConfiguration().getDccLocalAddress();</span>
<span class="nc bnc" id="L421" title="All 4 branches missed.">		address = (address != null &amp;&amp; destAddress.getClass().equals(address.getClass())) ? address : bot.getConfiguration().getLocalAddress();</span>
<span class="nc bnc" id="L422" title="All 4 branches missed.">		address = (address != null &amp;&amp; destAddress.getClass().equals(address.getClass())) ? address : bot.getLocalAddress();</span>
<span class="nc bnc" id="L423" title="All 4 branches missed.">		address = (address != null &amp;&amp; destAddress.getClass().equals(address.getClass())) ? address : null;</span>
<span class="nc" id="L424">		return address;</span>
	}
	
	public InetAddress getRealDccLocalAddress() {
<span class="nc" id="L428">		InetAddress address = bot.getConfiguration().getDccLocalAddress();</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">		address = (address != null) ? address : bot.getConfiguration().getLocalAddress();</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">		address = (address != null) ? address : bot.getLocalAddress();</span>
<span class="nc" id="L431">		return address;</span>
	}
	
	/**
	 * Try to get a real InetAddress in this order:
	 * &lt;ol&gt;
	 * &lt;li&gt;{@link Configuration#getDccPublicAddress()}&lt;/li&gt;
	 * &lt;li&gt;{@link #getRealDccLocalAddress() }&lt;/li&gt;
	 * &lt;/ol&gt;
	 */
	public InetAddress getRealDccPublicAddress() {
<span class="nc" id="L442">		InetAddress address = bot.getConfiguration().getDccPublicAddress();</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">		return (address != null) ? address : getRealDccLocalAddress();</span>
	}
	
	/**
	 * Try to get a real InetAddress in this order:
	 * &lt;ol&gt;
	 * &lt;li&gt;{@link Configuration#getDccPublicAddress()}&lt;/li&gt;
	 * &lt;li&gt;The given ServerSocket's address&lt;/li&gt;
	 * &lt;/ol&gt;
	 */
	public InetAddress getRealDccPublicAddress(ServerSocket ss) {
<span class="nc" id="L454">		InetAddress address = bot.getConfiguration().getDccPublicAddress();</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">		return (address != null) ? address : ss.getInetAddress();</span>
	}
	
	protected ServerSocket createServerSocket(User user) throws IOException, DccException {
<span class="nc" id="L459">		InetAddress address = getRealDccLocalAddress();</span>
<span class="nc" id="L460">		ImmutableList&lt;Integer&gt; dccPorts = bot.getConfiguration().getDccPorts();</span>
<span class="nc" id="L461">		ServerSocket ss = null;</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">		if (dccPorts.isEmpty()) </span>
		// Use any free port.
<span class="nc" id="L464">		ss = new ServerSocket(0, 1, address); else {</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">			for (int currentPort : dccPorts) try {</span>
<span class="nc" id="L466">				ss = new ServerSocket(currentPort, 1, address);</span>
				// Found a port number we could use.
<span class="nc" id="L468">				break;</span>
<span class="nc" id="L469">			} catch (Exception e) {</span>
				// Do nothing; go round and try another port.
<span class="nc" id="L471">				log.debug(&quot;Failed to create server socket on port &quot; + currentPort + &quot;, trying next one&quot;, e);</span>
<span class="nc" id="L472">			}</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">			if (ss == null) </span>
			// No ports could be used.
<span class="nc" id="L475">			throw new DccException(DccException.Reason.DccPortsInUse, user, &quot;Ports &quot; + dccPorts + &quot; are in use.&quot;);</span>
		}
<span class="nc" id="L477">		ss.setSoTimeout(bot.getConfiguration().getDccAcceptTimeout());</span>
<span class="nc" id="L478">		return ss;</span>
	}
	
	protected static List&lt;String&gt; tokenizeDccRequest(String request) {
<span class="fc" id="L482">		int quotesIndexBegin = request.indexOf('\&quot;');</span>
<span class="pc bpc" id="L483" title="1 of 2 branches missed.">		if (quotesIndexBegin == -1) </span>
		//Just use tokenizeLine
<span class="fc" id="L485">		return Utils.tokenizeLine(request);</span>
		//This is a slightly modified version of Utils.tokenizeLine to parse
		//potential quotes in filenames
<span class="nc" id="L488">		int quotesIndexEnd = request.lastIndexOf('\&quot;');</span>
<span class="nc" id="L489">		List&lt;String&gt; stringParts = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L490">		int pos = 0;</span>
		int end;
<span class="nc bnc" id="L492" title="All 2 branches missed.">		while ((end = request.indexOf(' ', pos)) &gt;= 0) {</span>
<span class="nc bnc" id="L493" title="All 4 branches missed.">			if (pos &gt;= quotesIndexBegin &amp;&amp; end &lt; quotesIndexEnd) {</span>
				//We've entered the filename. Add and skip
<span class="nc" id="L495">				stringParts.add(request.substring(quotesIndexBegin, quotesIndexEnd + 1));</span>
<span class="nc" id="L496">				pos = quotesIndexEnd + 2;</span>
<span class="nc" id="L497">				continue;</span>
			}
<span class="nc" id="L499">			stringParts.add(request.substring(pos, end));</span>
<span class="nc" id="L500">			pos = end + 1;</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">			if (request.charAt(pos) == ':') {</span>
<span class="nc" id="L502">				stringParts.add(request.substring(pos + 1));</span>
<span class="nc" id="L503">				return stringParts;</span>
			}
		}
		//No more spaces, add last part of line
<span class="nc" id="L507">		stringParts.add(request.substring(pos));</span>
<span class="nc" id="L508">		return stringParts;</span>
	}
	
	/**
	 * Shutdown any pending dcc transfers
	 */
	public void close() {
		//Shutdown open reverse dcc servers
<span class="fc" id="L516">		shuttingDown = true;</span>
<span class="fc" id="L517">		int pendingCount = pendingReceiveTransfers.values().size() + pendingSendPassiveTransfers.values().size();</span>
<span class="pc bpc" id="L518" title="1 of 2 branches missed.">		if (pendingCount &gt; 0) {</span>
<span class="nc" id="L519">			log.info(&quot;Terminating {} DCC transfers waiting to be accepted&quot;, pendingCount);</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">			for (CountDownLatch curCountdown : pendingReceiveTransfers.values()) curCountdown.countDown();</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">			for (CountDownLatch curCountdown : pendingSendPassiveTransfers.values()) curCountdown.countDown();</span>
		}
<span class="fc" id="L523">	}</span>
	
	public static String addressToInteger(InetAddress address) {
<span class="fc bfc" id="L526" title="All 2 branches covered.">		if (address instanceof Inet6Address) return address.getHostAddress();</span>
<span class="fc" id="L527">		return new BigInteger(1, address.getAddress()).toString();</span>
	}
	
	public static InetAddress parseRawAddress(String rawAddress) throws UnknownHostException {
		//Some IPv6 clients are sending the full IPv6 address instead of a bigint
<span class="fc bfc" id="L532" title="All 2 branches covered.">		if (rawAddress.contains(&quot;:&quot;)) return Inet6Address.getByName(rawAddress);</span>
		//Convert the rawInteger into something usable
<span class="fc" id="L534">		BigInteger bigIp = new BigInteger(rawAddress);</span>
<span class="fc" id="L535">		byte[] addressBytes = bigIp.toByteArray();</span>
		//If there aren't enough bytes, pad with 0 byte
<span class="fc bfc" id="L537" title="All 2 branches covered.">		if (addressBytes.length == 5) </span>
		//Has signum, strip it
<span class="fc bfc" id="L539" title="All 2 branches covered.">		addressBytes = Arrays.copyOfRange(addressBytes, 1, 5); else if (addressBytes.length &lt; 4) {</span>
<span class="fc" id="L540">			byte[] newAddressBytes = new byte[4];</span>
<span class="fc" id="L541">			newAddressBytes[3] = addressBytes[0];</span>
<span class="pc bpc" id="L542" title="1 of 2 branches missed.">			newAddressBytes[2] = (addressBytes.length &gt; 1) ? addressBytes[1] : (byte)0;</span>
<span class="pc bpc" id="L543" title="1 of 2 branches missed.">			newAddressBytes[1] = (addressBytes.length &gt; 2) ? addressBytes[2] : (byte)0;</span>
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">			newAddressBytes[0] = (addressBytes.length &gt; 3) ? addressBytes[3] : (byte)0;</span>
<span class="fc" id="L545">			addressBytes = newAddressBytes;</span>
<span class="pc bpc" id="L546" title="1 of 2 branches missed.">		} else if (addressBytes.length == 17) </span>
		//Has signum, strip it
<span class="nc" id="L548">		addressBytes = Arrays.copyOfRange(addressBytes, 1, 17);</span>
		try {
<span class="fc" id="L550">			return InetAddress.getByAddress(addressBytes);</span>
<span class="nc" id="L551">		} catch (UnknownHostException ex) {</span>
<span class="nc" id="L552">			throw new RuntimeException(&quot;Can\'t get InetAdrress version of int IP address &quot; + rawAddress + &quot; (bytes: &quot; + Arrays.toString(addressBytes) + &quot;)&quot;, ex);</span>
		}
	}
	
	protected static class PendingRecieveFileTransfer {
		protected final IncomingFileTransferEvent event;
		protected long position;
		
		@java.beans.ConstructorProperties({&quot;event&quot;})
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
<span class="nc" id="L563">		public PendingRecieveFileTransfer(final IncomingFileTransferEvent event) {</span>
<span class="nc" id="L564">			this.event = event;</span>
<span class="nc" id="L565">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public IncomingFileTransferEvent getEvent() {
<span class="nc" id="L570">			return this.event;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public long getPosition() {
<span class="nc" id="L576">			return this.position;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setPosition(final long position) {
<span class="nc" id="L582">			this.position = position;</span>
<span class="nc" id="L583">		}</span>
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public boolean equals(final java.lang.Object o) {
<span class="nc bnc" id="L589" title="All 2 branches missed.">			if (o == this) return true;</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">			if (!(o instanceof DccHandler.PendingRecieveFileTransfer)) return false;</span>
<span class="nc" id="L591">			final PendingRecieveFileTransfer other = (PendingRecieveFileTransfer)o;</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">			if (!other.canEqual((java.lang.Object)this)) return false;</span>
<span class="nc" id="L593">			final java.lang.Object this$event = this.getEvent();</span>
<span class="nc" id="L594">			final java.lang.Object other$event = other.getEvent();</span>
<span class="nc bnc" id="L595" title="All 6 branches missed.">			if (this$event == null ? other$event != null : !this$event.equals(other$event)) return false;</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">			if (this.getPosition() != other.getPosition()) return false;</span>
<span class="nc" id="L597">			return true;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		protected boolean canEqual(final java.lang.Object other) {
<span class="nc" id="L603">			return other instanceof DccHandler.PendingRecieveFileTransfer;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int hashCode() {
<span class="nc" id="L610">			final int PRIME = 59;</span>
<span class="nc" id="L611">			int result = 1;</span>
<span class="nc" id="L612">			final java.lang.Object $event = this.getEvent();</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">			result = result * PRIME + ($event == null ? 43 : $event.hashCode());</span>
<span class="nc" id="L614">			final long $position = this.getPosition();</span>
<span class="nc" id="L615">			result = result * PRIME + (int)($position &gt;&gt;&gt; 32 ^ $position);</span>
<span class="nc" id="L616">			return result;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public java.lang.String toString() {
<span class="nc" id="L623">			return &quot;DccHandler.PendingRecieveFileTransfer(event=&quot; + this.getEvent() + &quot;, position=&quot; + this.getPosition() + &quot;)&quot;;</span>
		}
	}
	
	protected static class PendingSendFileTransfer {
		protected final User user;
		protected final String filename;
		protected final int port;
<span class="nc" id="L631">		protected long position = 0;</span>
		
		@java.beans.ConstructorProperties({&quot;user&quot;, &quot;filename&quot;, &quot;port&quot;})
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
<span class="nc" id="L636">		public PendingSendFileTransfer(final User user, final String filename, final int port) {</span>
<span class="nc" id="L637">			this.user = user;</span>
<span class="nc" id="L638">			this.filename = filename;</span>
<span class="nc" id="L639">			this.port = port;</span>
<span class="nc" id="L640">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public User getUser() {
<span class="nc" id="L645">			return this.user;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public String getFilename() {
<span class="nc" id="L651">			return this.filename;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int getPort() {
<span class="nc" id="L657">			return this.port;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public long getPosition() {
<span class="nc" id="L663">			return this.position;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setPosition(final long position) {
<span class="nc" id="L669">			this.position = position;</span>
<span class="nc" id="L670">		}</span>
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public boolean equals(final java.lang.Object o) {
<span class="nc bnc" id="L676" title="All 2 branches missed.">			if (o == this) return true;</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">			if (!(o instanceof DccHandler.PendingSendFileTransfer)) return false;</span>
<span class="nc" id="L678">			final PendingSendFileTransfer other = (PendingSendFileTransfer)o;</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">			if (!other.canEqual((java.lang.Object)this)) return false;</span>
<span class="nc" id="L680">			final java.lang.Object this$user = this.getUser();</span>
<span class="nc" id="L681">			final java.lang.Object other$user = other.getUser();</span>
<span class="nc bnc" id="L682" title="All 6 branches missed.">			if (this$user == null ? other$user != null : !this$user.equals(other$user)) return false;</span>
<span class="nc" id="L683">			final java.lang.Object this$filename = this.getFilename();</span>
<span class="nc" id="L684">			final java.lang.Object other$filename = other.getFilename();</span>
<span class="nc bnc" id="L685" title="All 6 branches missed.">			if (this$filename == null ? other$filename != null : !this$filename.equals(other$filename)) return false;</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">			if (this.getPort() != other.getPort()) return false;</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">			if (this.getPosition() != other.getPosition()) return false;</span>
<span class="nc" id="L688">			return true;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		protected boolean canEqual(final java.lang.Object other) {
<span class="nc" id="L694">			return other instanceof DccHandler.PendingSendFileTransfer;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int hashCode() {
<span class="nc" id="L701">			final int PRIME = 59;</span>
<span class="nc" id="L702">			int result = 1;</span>
<span class="nc" id="L703">			final java.lang.Object $user = this.getUser();</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">			result = result * PRIME + ($user == null ? 43 : $user.hashCode());</span>
<span class="nc" id="L705">			final java.lang.Object $filename = this.getFilename();</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">			result = result * PRIME + ($filename == null ? 43 : $filename.hashCode());</span>
<span class="nc" id="L707">			result = result * PRIME + this.getPort();</span>
<span class="nc" id="L708">			final long $position = this.getPosition();</span>
<span class="nc" id="L709">			result = result * PRIME + (int)($position &gt;&gt;&gt; 32 ^ $position);</span>
<span class="nc" id="L710">			return result;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public java.lang.String toString() {
<span class="nc" id="L717">			return &quot;DccHandler.PendingSendFileTransfer(user=&quot; + this.getUser() + &quot;, filename=&quot; + this.getFilename() + &quot;, port=&quot; + this.getPort() + &quot;, position=&quot; + this.getPosition() + &quot;)&quot;;</span>
		}
	}
	
	protected static class PendingSendFileTransferPassive {
		protected final User user;
		protected final String filename;
		protected final String transferToken;
<span class="nc" id="L725">		protected long startPosition = 0;</span>
		protected InetAddress receiverAddress;
		protected int receiverPort;
		
		@java.beans.ConstructorProperties({&quot;user&quot;, &quot;filename&quot;, &quot;transferToken&quot;})
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
<span class="nc" id="L732">		public PendingSendFileTransferPassive(final User user, final String filename, final String transferToken) {</span>
<span class="nc" id="L733">			this.user = user;</span>
<span class="nc" id="L734">			this.filename = filename;</span>
<span class="nc" id="L735">			this.transferToken = transferToken;</span>
<span class="nc" id="L736">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public User getUser() {
<span class="nc" id="L741">			return this.user;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public String getFilename() {
<span class="nc" id="L747">			return this.filename;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public String getTransferToken() {
<span class="nc" id="L753">			return this.transferToken;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public long getStartPosition() {
<span class="nc" id="L759">			return this.startPosition;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public InetAddress getReceiverAddress() {
<span class="nc" id="L765">			return this.receiverAddress;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int getReceiverPort() {
<span class="nc" id="L771">			return this.receiverPort;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setStartPosition(final long startPosition) {
<span class="nc" id="L777">			this.startPosition = startPosition;</span>
<span class="nc" id="L778">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setReceiverAddress(final InetAddress receiverAddress) {
<span class="nc" id="L783">			this.receiverAddress = receiverAddress;</span>
<span class="nc" id="L784">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setReceiverPort(final int receiverPort) {
<span class="nc" id="L789">			this.receiverPort = receiverPort;</span>
<span class="nc" id="L790">		}</span>
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public boolean equals(final java.lang.Object o) {
<span class="nc bnc" id="L796" title="All 2 branches missed.">			if (o == this) return true;</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">			if (!(o instanceof DccHandler.PendingSendFileTransferPassive)) return false;</span>
<span class="nc" id="L798">			final PendingSendFileTransferPassive other = (PendingSendFileTransferPassive)o;</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">			if (!other.canEqual((java.lang.Object)this)) return false;</span>
<span class="nc" id="L800">			final java.lang.Object this$user = this.getUser();</span>
<span class="nc" id="L801">			final java.lang.Object other$user = other.getUser();</span>
<span class="nc bnc" id="L802" title="All 6 branches missed.">			if (this$user == null ? other$user != null : !this$user.equals(other$user)) return false;</span>
<span class="nc" id="L803">			final java.lang.Object this$filename = this.getFilename();</span>
<span class="nc" id="L804">			final java.lang.Object other$filename = other.getFilename();</span>
<span class="nc bnc" id="L805" title="All 6 branches missed.">			if (this$filename == null ? other$filename != null : !this$filename.equals(other$filename)) return false;</span>
<span class="nc" id="L806">			final java.lang.Object this$transferToken = this.getTransferToken();</span>
<span class="nc" id="L807">			final java.lang.Object other$transferToken = other.getTransferToken();</span>
<span class="nc bnc" id="L808" title="All 6 branches missed.">			if (this$transferToken == null ? other$transferToken != null : !this$transferToken.equals(other$transferToken)) return false;</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">			if (this.getStartPosition() != other.getStartPosition()) return false;</span>
<span class="nc" id="L810">			final java.lang.Object this$receiverAddress = this.getReceiverAddress();</span>
<span class="nc" id="L811">			final java.lang.Object other$receiverAddress = other.getReceiverAddress();</span>
<span class="nc bnc" id="L812" title="All 6 branches missed.">			if (this$receiverAddress == null ? other$receiverAddress != null : !this$receiverAddress.equals(other$receiverAddress)) return false;</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">			if (this.getReceiverPort() != other.getReceiverPort()) return false;</span>
<span class="nc" id="L814">			return true;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		protected boolean canEqual(final java.lang.Object other) {
<span class="nc" id="L820">			return other instanceof DccHandler.PendingSendFileTransferPassive;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int hashCode() {
<span class="nc" id="L827">			final int PRIME = 59;</span>
<span class="nc" id="L828">			int result = 1;</span>
<span class="nc" id="L829">			final java.lang.Object $user = this.getUser();</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">			result = result * PRIME + ($user == null ? 43 : $user.hashCode());</span>
<span class="nc" id="L831">			final java.lang.Object $filename = this.getFilename();</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">			result = result * PRIME + ($filename == null ? 43 : $filename.hashCode());</span>
<span class="nc" id="L833">			final java.lang.Object $transferToken = this.getTransferToken();</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">			result = result * PRIME + ($transferToken == null ? 43 : $transferToken.hashCode());</span>
<span class="nc" id="L835">			final long $startPosition = this.getStartPosition();</span>
<span class="nc" id="L836">			result = result * PRIME + (int)($startPosition &gt;&gt;&gt; 32 ^ $startPosition);</span>
<span class="nc" id="L837">			final java.lang.Object $receiverAddress = this.getReceiverAddress();</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">			result = result * PRIME + ($receiverAddress == null ? 43 : $receiverAddress.hashCode());</span>
<span class="nc" id="L839">			result = result * PRIME + this.getReceiverPort();</span>
<span class="nc" id="L840">			return result;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public java.lang.String toString() {
<span class="nc" id="L847">			return &quot;DccHandler.PendingSendFileTransferPassive(user=&quot; + this.getUser() + &quot;, filename=&quot; + this.getFilename() + &quot;, transferToken=&quot; + this.getTransferToken() + &quot;, startPosition=&quot; + this.getStartPosition() + &quot;, receiverAddress=&quot; + this.getReceiverAddress() + &quot;, receiverPort=&quot; + this.getReceiverPort() + &quot;)&quot;;</span>
		}
	}
	
	protected static class PendingSendChatPassive {
		protected final User user;
		protected final String chatToken;
		protected InetAddress receiverAddress;
		protected int receiverPort;
		
		@java.beans.ConstructorProperties({&quot;user&quot;, &quot;chatToken&quot;})
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
<span class="nc" id="L860">		public PendingSendChatPassive(final User user, final String chatToken) {</span>
<span class="nc" id="L861">			this.user = user;</span>
<span class="nc" id="L862">			this.chatToken = chatToken;</span>
<span class="nc" id="L863">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public User getUser() {
<span class="nc" id="L868">			return this.user;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public String getChatToken() {
<span class="nc" id="L874">			return this.chatToken;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public InetAddress getReceiverAddress() {
<span class="nc" id="L880">			return this.receiverAddress;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int getReceiverPort() {
<span class="nc" id="L886">			return this.receiverPort;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setReceiverAddress(final InetAddress receiverAddress) {
<span class="nc" id="L892">			this.receiverAddress = receiverAddress;</span>
<span class="nc" id="L893">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setReceiverPort(final int receiverPort) {
<span class="nc" id="L898">			this.receiverPort = receiverPort;</span>
<span class="nc" id="L899">		}</span>
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public boolean equals(final java.lang.Object o) {
<span class="nc bnc" id="L905" title="All 2 branches missed.">			if (o == this) return true;</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">			if (!(o instanceof DccHandler.PendingSendChatPassive)) return false;</span>
<span class="nc" id="L907">			final PendingSendChatPassive other = (PendingSendChatPassive)o;</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">			if (!other.canEqual((java.lang.Object)this)) return false;</span>
<span class="nc" id="L909">			final java.lang.Object this$user = this.getUser();</span>
<span class="nc" id="L910">			final java.lang.Object other$user = other.getUser();</span>
<span class="nc bnc" id="L911" title="All 6 branches missed.">			if (this$user == null ? other$user != null : !this$user.equals(other$user)) return false;</span>
<span class="nc" id="L912">			final java.lang.Object this$chatToken = this.getChatToken();</span>
<span class="nc" id="L913">			final java.lang.Object other$chatToken = other.getChatToken();</span>
<span class="nc bnc" id="L914" title="All 6 branches missed.">			if (this$chatToken == null ? other$chatToken != null : !this$chatToken.equals(other$chatToken)) return false;</span>
<span class="nc" id="L915">			final java.lang.Object this$receiverAddress = this.getReceiverAddress();</span>
<span class="nc" id="L916">			final java.lang.Object other$receiverAddress = other.getReceiverAddress();</span>
<span class="nc bnc" id="L917" title="All 6 branches missed.">			if (this$receiverAddress == null ? other$receiverAddress != null : !this$receiverAddress.equals(other$receiverAddress)) return false;</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">			if (this.getReceiverPort() != other.getReceiverPort()) return false;</span>
<span class="nc" id="L919">			return true;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		protected boolean canEqual(final java.lang.Object other) {
<span class="nc" id="L925">			return other instanceof DccHandler.PendingSendChatPassive;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int hashCode() {
<span class="nc" id="L932">			final int PRIME = 59;</span>
<span class="nc" id="L933">			int result = 1;</span>
<span class="nc" id="L934">			final java.lang.Object $user = this.getUser();</span>
<span class="nc bnc" id="L935" title="All 2 branches missed.">			result = result * PRIME + ($user == null ? 43 : $user.hashCode());</span>
<span class="nc" id="L936">			final java.lang.Object $chatToken = this.getChatToken();</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">			result = result * PRIME + ($chatToken == null ? 43 : $chatToken.hashCode());</span>
<span class="nc" id="L938">			final java.lang.Object $receiverAddress = this.getReceiverAddress();</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">			result = result * PRIME + ($receiverAddress == null ? 43 : $receiverAddress.hashCode());</span>
<span class="nc" id="L940">			result = result * PRIME + this.getReceiverPort();</span>
<span class="nc" id="L941">			return result;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public java.lang.String toString() {
<span class="nc" id="L948">			return &quot;DccHandler.PendingSendChatPassive(user=&quot; + this.getUser() + &quot;, chatToken=&quot; + this.getChatToken() + &quot;, receiverAddress=&quot; + this.getReceiverAddress() + &quot;, receiverPort=&quot; + this.getReceiverPort() + &quot;)&quot;;</span>
		}
	}
	
	public static void main(String[] args) throws UnknownHostException {
<span class="nc" id="L953">		log.debug(&quot;IP: {}&quot;, parseRawAddress(&quot;134744072&quot;));</span>
<span class="nc" id="L954">	}</span>
	
	@java.beans.ConstructorProperties({&quot;bot&quot;})
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
<span class="fc" id="L959">	public DccHandler(@NonNull final PircBotX bot) {</span>
<span class="pc bpc" id="L960" title="1 of 2 branches missed.">		if (bot == null) {</span>
<span class="nc" id="L961">			throw new java.lang.NullPointerException(&quot;bot&quot;);</span>
		}
<span class="fc" id="L963">		this.bot = bot;</span>
<span class="fc" id="L964">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>