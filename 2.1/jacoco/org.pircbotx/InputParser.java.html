<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>InputParser.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pircbotx</a> &gt; <a href="index.source.html" class="el_package">org.pircbotx</a> &gt; <span class="el_source">InputParser.java</span></div><h1>InputParser.java</h1><pre class="source lang-java linenums">// Generated by delombok at Sun Jan 24 05:08:02 EST 2016
/**
 * Copyright (C) 2010-2014 Leon Blakey &lt;lord.quackstar at gmail.com&gt;
 *
 * This file is part of PircBotX.
 *
 * PircBotX is free software: you can redistribute it and/or modify it under the
 * terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 *
 * PircBotX is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * PircBotX. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.pircbotx;

import org.pircbotx.snapshot.UserSnapshot;
import com.google.common.base.CharMatcher;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Iterators;
import com.google.common.collect.LinkedListMultimap;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.collect.Multimap;
import com.google.common.collect.PeekingIterator;
import java.io.BufferedReader;
import java.io.Closeable;
import java.io.IOException;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.StringTokenizer;
import javax.net.ssl.SSLSocket;
import javax.net.ssl.SSLSocketFactory;
import lombok.NonNull;
import org.apache.commons.lang3.StringUtils;
import static org.pircbotx.ReplyConstants.*;
import org.pircbotx.cap.CapHandler;
import org.pircbotx.cap.TLSCapHandler;
import org.pircbotx.exception.IrcException;
import org.pircbotx.hooks.events.ActionEvent;
import org.pircbotx.hooks.events.BanListEvent;
import org.pircbotx.hooks.events.ChannelInfoEvent;
import org.pircbotx.hooks.events.ConnectEvent;
import org.pircbotx.hooks.events.FingerEvent;
import org.pircbotx.hooks.events.HalfOpEvent;
import org.pircbotx.hooks.events.InviteEvent;
import org.pircbotx.hooks.events.JoinEvent;
import org.pircbotx.hooks.events.KickEvent;
import org.pircbotx.hooks.events.MessageEvent;
import org.pircbotx.hooks.events.ModeEvent;
import org.pircbotx.hooks.events.MotdEvent;
import org.pircbotx.hooks.events.NickAlreadyInUseEvent;
import org.pircbotx.hooks.events.NickChangeEvent;
import org.pircbotx.hooks.events.NoticeEvent;
import org.pircbotx.hooks.events.OpEvent;
import org.pircbotx.hooks.events.OwnerEvent;
import org.pircbotx.hooks.events.PartEvent;
import org.pircbotx.hooks.events.PingEvent;
import org.pircbotx.hooks.events.PrivateMessageEvent;
import org.pircbotx.hooks.events.QuitEvent;
import org.pircbotx.hooks.events.RemoveChannelBanEvent;
import org.pircbotx.hooks.events.RemoveChannelKeyEvent;
import org.pircbotx.hooks.events.RemoveChannelLimitEvent;
import org.pircbotx.hooks.events.RemoveInviteOnlyEvent;
import org.pircbotx.hooks.events.RemoveModeratedEvent;
import org.pircbotx.hooks.events.RemoveNoExternalMessagesEvent;
import org.pircbotx.hooks.events.RemovePrivateEvent;
import org.pircbotx.hooks.events.RemoveSecretEvent;
import org.pircbotx.hooks.events.RemoveTopicProtectionEvent;
import org.pircbotx.hooks.events.ServerPingEvent;
import org.pircbotx.hooks.events.ServerResponseEvent;
import org.pircbotx.hooks.events.SetChannelBanEvent;
import org.pircbotx.hooks.events.SetChannelKeyEvent;
import org.pircbotx.hooks.events.SetChannelLimitEvent;
import org.pircbotx.hooks.events.SetInviteOnlyEvent;
import org.pircbotx.hooks.events.SetModeratedEvent;
import org.pircbotx.hooks.events.SetNoExternalMessagesEvent;
import org.pircbotx.hooks.events.SetPrivateEvent;
import org.pircbotx.hooks.events.SetSecretEvent;
import org.pircbotx.hooks.events.SetTopicProtectionEvent;
import org.pircbotx.hooks.events.SuperOpEvent;
import org.pircbotx.hooks.events.TimeEvent;
import org.pircbotx.hooks.events.TopicEvent;
import org.pircbotx.hooks.events.UnknownEvent;
import org.pircbotx.hooks.events.UserListEvent;
import org.pircbotx.hooks.events.UserModeEvent;
import org.pircbotx.hooks.events.VersionEvent;
import org.pircbotx.hooks.events.VoiceEvent;
import org.pircbotx.hooks.events.WhoisEvent;
import org.pircbotx.snapshot.ChannelSnapshot;
import org.pircbotx.snapshot.UserChannelDaoSnapshot;
import org.slf4j.Marker;
import org.slf4j.MarkerFactory;

/**
 * Parse received input from IRC server.
 *
 * @author Leon Blakey
 */
public class InputParser implements Closeable {
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
<span class="fc" id="L110">	private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(InputParser.class);</span>
<span class="fc" id="L111">	public static final Marker INPUT_MARKER = MarkerFactory.getMarker(&quot;pircbotx.input&quot;);</span>
	
	/**
	 * Codes that say we are connected: Initial connection (001-4), user stats
	 * (251-5), or MOTD (375-6).
	 */
<span class="fc" id="L117">	protected static final ImmutableList&lt;String&gt; CONNECT_CODES = ImmutableList.of(&quot;001&quot;, &quot;002&quot;, &quot;003&quot;, &quot;004&quot;, &quot;005&quot;, &quot;251&quot;, &quot;252&quot;, &quot;253&quot;, &quot;254&quot;, &quot;255&quot;, &quot;375&quot;, &quot;376&quot;);</span>
	protected static final ImmutableList&lt;ChannelModeHandler&gt; DEFAULT_CHANNEL_MODE_HANDLERS;
	static {
<span class="fc" id="L120">		DEFAULT_CHANNEL_MODE_HANDLERS = ImmutableList.&lt;ChannelModeHandler&gt;builder().add(new OpChannelModeHandler('o', UserLevel.OP){</span>


			@Override
			public void dispatchEvent(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, UserHostmask recipientHostmask, User recipientUser, boolean adding) {
<span class="fc" id="L125">				Utils.dispatchEvent(bot, new OpEvent(bot, channel, sourceHostmask, sourceUser, recipientHostmask, recipientUser, adding));</span>
<span class="fc" id="L126">			}</span>
<span class="fc" id="L127">		}).add(new OpChannelModeHandler('v', UserLevel.VOICE){</span>


			@Override
			public void dispatchEvent(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, UserHostmask recipientHostmask, User recipientUser, boolean adding) {
<span class="fc" id="L132">				Utils.dispatchEvent(bot, new VoiceEvent(bot, channel, sourceHostmask, sourceUser, recipientHostmask, recipientUser, adding));</span>
<span class="fc" id="L133">			}</span>
<span class="fc" id="L134">		}).add(new OpChannelModeHandler('h', UserLevel.HALFOP){</span>


			@Override
			public void dispatchEvent(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, UserHostmask recipientHostmask, User recipientUser, boolean adding) {
<span class="fc" id="L139">				Utils.dispatchEvent(bot, new HalfOpEvent(bot, channel, sourceHostmask, sourceUser, recipientHostmask, recipientUser, adding));</span>
<span class="fc" id="L140">			}</span>
<span class="fc" id="L141">		}).add(new OpChannelModeHandler('a', UserLevel.SUPEROP){</span>


			@Override
			public void dispatchEvent(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, UserHostmask recipientHostmask, User recipientUser, boolean adding) {
<span class="fc" id="L146">				Utils.dispatchEvent(bot, new SuperOpEvent(bot, channel, sourceHostmask, sourceUser, recipientHostmask, recipientUser, adding));</span>
<span class="fc" id="L147">			}</span>
<span class="fc" id="L148">		}).add(new OpChannelModeHandler('q', UserLevel.OWNER){</span>


			@Override
			public void dispatchEvent(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, UserHostmask recipientHostmask, User recipientUser, boolean adding) {
<span class="fc" id="L153">				Utils.dispatchEvent(bot, new OwnerEvent(bot, channel, sourceHostmask, sourceUser, recipientHostmask, recipientUser, adding));</span>
<span class="fc" id="L154">			}</span>
<span class="fc" id="L155">		}).add(new ChannelModeHandler('k'){</span>


			@Override
			public void handleMode(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, PeekingIterator&lt;String&gt; params, boolean adding, boolean dispatchEvent) {
<span class="fc bfc" id="L160" title="All 2 branches covered.">				if (adding) {</span>
<span class="fc" id="L161">					String key = params.next();</span>
<span class="fc" id="L162">					channel.setChannelKey(key);</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">					if (dispatchEvent) Utils.dispatchEvent(bot, new SetChannelKeyEvent(bot, channel, sourceHostmask, sourceUser, key));</span>
<span class="fc" id="L164">				} else {</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">					String key = params.hasNext() ? params.next() : null;</span>
<span class="fc" id="L166">					channel.setChannelKey(null);</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">					if (dispatchEvent) Utils.dispatchEvent(bot, new RemoveChannelKeyEvent(bot, channel, sourceHostmask, sourceUser, key));</span>
				}
<span class="fc" id="L169">			}</span>
<span class="fc" id="L170">		}).add(new ChannelModeHandler('l'){</span>


			@Override
			public void handleMode(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, PeekingIterator&lt;String&gt; params, boolean adding, boolean dispatchEvent) {
<span class="fc bfc" id="L175" title="All 2 branches covered.">				if (adding) {</span>
<span class="fc" id="L176">					int limit = Integer.parseInt(params.next());</span>
<span class="fc" id="L177">					channel.setChannelLimit(limit);</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">					if (dispatchEvent) Utils.dispatchEvent(bot, new SetChannelLimitEvent(bot, channel, sourceHostmask, sourceUser, limit));</span>
<span class="fc" id="L179">				} else {</span>
<span class="fc" id="L180">					channel.setChannelLimit(-1);</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">					if (dispatchEvent) Utils.dispatchEvent(bot, new RemoveChannelLimitEvent(bot, channel, sourceHostmask, sourceUser));</span>
				}
<span class="fc" id="L183">			}</span>
<span class="fc" id="L184">		}).add(new ChannelModeHandler('b'){</span>


			@Override
			public void handleMode(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, PeekingIterator&lt;String&gt; params, boolean adding, boolean dispatchEvent) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">				if (dispatchEvent) {</span>
<span class="nc" id="L190">					UserHostmask banHostmask = bot.getConfiguration().getBotFactory().createUserHostmask(bot, params.next());</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">					if (adding) Utils.dispatchEvent(bot, new SetChannelBanEvent(bot, channel, sourceHostmask, sourceUser, banHostmask)); else Utils.dispatchEvent(bot, new RemoveChannelBanEvent(bot, channel, sourceHostmask, sourceUser, banHostmask));</span>
				}
<span class="nc" id="L193">			}</span>
<span class="fc" id="L194">		}).add(new ChannelModeHandler('t'){</span>


			@Override
			public void handleMode(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, PeekingIterator&lt;String&gt; params, boolean adding, boolean dispatchEvent) {
<span class="fc" id="L199">				channel.setTopicProtection(adding);</span>
<span class="fc bfc" id="L200" title="All 4 branches covered.">				if (dispatchEvent) if (adding) Utils.dispatchEvent(bot, new SetTopicProtectionEvent(bot, channel, sourceHostmask, sourceUser)); else Utils.dispatchEvent(bot, new RemoveTopicProtectionEvent(bot, channel, sourceHostmask, sourceUser));</span>
<span class="fc" id="L201">			}</span>
<span class="fc" id="L202">		}).add(new ChannelModeHandler('n'){</span>


			@Override
			public void handleMode(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, PeekingIterator&lt;String&gt; params, boolean adding, boolean dispatchEvent) {
<span class="fc" id="L207">				channel.setNoExternalMessages(adding);</span>
<span class="fc bfc" id="L208" title="All 4 branches covered.">				if (dispatchEvent) if (adding) Utils.dispatchEvent(bot, new SetNoExternalMessagesEvent(bot, channel, sourceHostmask, sourceUser)); else Utils.dispatchEvent(bot, new RemoveNoExternalMessagesEvent(bot, channel, sourceHostmask, sourceUser));</span>
<span class="fc" id="L209">			}</span>
<span class="fc" id="L210">		}).add(new ChannelModeHandler('i'){</span>


			@Override
			public void handleMode(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, PeekingIterator&lt;String&gt; params, boolean adding, boolean dispatchEvent) {
<span class="fc" id="L215">				channel.setInviteOnly(adding);</span>
<span class="fc bfc" id="L216" title="All 4 branches covered.">				if (dispatchEvent) if (adding) Utils.dispatchEvent(bot, new SetInviteOnlyEvent(bot, channel, sourceHostmask, sourceUser)); else Utils.dispatchEvent(bot, new RemoveInviteOnlyEvent(bot, channel, sourceHostmask, sourceUser));</span>
<span class="fc" id="L217">			}</span>
<span class="fc" id="L218">		}).add(new ChannelModeHandler('m'){</span>


			@Override
			public void handleMode(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, PeekingIterator&lt;String&gt; params, boolean adding, boolean dispatchEvent) {
<span class="fc" id="L223">				channel.setModerated(adding);</span>
<span class="pc bpc" id="L224" title="3 of 4 branches missed.">				if (dispatchEvent) if (adding) Utils.dispatchEvent(bot, new SetModeratedEvent(bot, channel, sourceHostmask, sourceUser)); else Utils.dispatchEvent(bot, new RemoveModeratedEvent(bot, channel, sourceHostmask, sourceUser));</span>
<span class="fc" id="L225">			}</span>
<span class="fc" id="L226">		}).add(new ChannelModeHandler('p'){</span>


			@Override
			public void handleMode(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, PeekingIterator&lt;String&gt; params, boolean adding, boolean dispatchEvent) {
<span class="fc" id="L231">				channel.setChannelPrivate(adding);</span>
<span class="fc bfc" id="L232" title="All 4 branches covered.">				if (dispatchEvent) if (adding) Utils.dispatchEvent(bot, new SetPrivateEvent(bot, channel, sourceHostmask, sourceUser)); else Utils.dispatchEvent(bot, new RemovePrivateEvent(bot, channel, sourceHostmask, sourceUser));</span>
<span class="fc" id="L233">			}</span>
<span class="fc" id="L234">		}).add(new ChannelModeHandler('s'){</span>


			@Override
			public void handleMode(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, PeekingIterator&lt;String&gt; params, boolean adding, boolean dispatchEvent) {
<span class="fc" id="L239">				channel.setSecret(adding);</span>
<span class="fc bfc" id="L240" title="All 4 branches covered.">				if (dispatchEvent) if (adding) Utils.dispatchEvent(bot, new SetSecretEvent(bot, channel, sourceHostmask, sourceUser)); else Utils.dispatchEvent(bot, new RemoveSecretEvent(bot, channel, sourceHostmask, sourceUser));</span>
<span class="fc" id="L241">			}</span>
<span class="fc" id="L242">		}).build();</span>
<span class="fc" id="L243">	}</span>
	protected final Configuration configuration;
	protected final PircBotX bot;
<span class="pc" id="L246">	protected final List&lt;CapHandler&gt; capHandlersFinished = Lists.newArrayList();</span>
<span class="pc" id="L247">	protected boolean capEndSent = false;</span>
	protected BufferedReader inputReader;
	//Builders
	/**
	 * Map to keep active WhoisEvents. Must be a treemap to be case insensitive
	 */
<span class="pc" id="L253">	protected final Map&lt;String, WhoisEvent.Builder&gt; whoisBuilder = Maps.newTreeMap(String.CASE_INSENSITIVE_ORDER);</span>
	protected StringBuilder motdBuilder;
<span class="pc" id="L255">	protected boolean channelListRunning = false;</span>
	protected ImmutableList.Builder&lt;ChannelListEntry&gt; channelListBuilder;
<span class="pc" id="L257">	protected int nickSuffix = 0;</span>
<span class="pc" id="L258">	protected final Multimap&lt;Channel, BanListEvent.Entry&gt; banListBuilder = LinkedListMultimap.create();</span>

<span class="fc" id="L260">	public InputParser(PircBotX bot) {</span>
<span class="fc" id="L261">		this.bot = bot;</span>
<span class="fc" id="L262">		this.configuration = bot.getConfiguration();</span>
<span class="fc" id="L263">	}</span>

	/**
	 * This method handles events when any line of text arrives from the server,
	 * then dispatching the appropriate event.
	 *
	 * @param rawLine The raw line of text from the server.
	 */
	public void handleLine(@NonNull String rawLine) throws IOException, IrcException {
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">		if (rawLine == null) {</span>
<span class="nc" id="L273">			throw new java.lang.NullPointerException(&quot;rawLine&quot;);</span>
		}
<span class="fc" id="L275">		String line = CharMatcher.WHITESPACE.trimFrom(rawLine);</span>
<span class="fc" id="L276">		log.info(INPUT_MARKER, line);</span>
		// Parse out v3Tags before
<span class="fc" id="L278">		ImmutableMap.Builder&lt;String, String&gt; tags = ImmutableMap.builder();</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">		if (line.startsWith(&quot;@&quot;)) {</span>
			//This message has IRCv3 tags
<span class="nc" id="L281">			String v3Tags = line.substring(1, line.indexOf(&quot; &quot;));</span>
<span class="nc" id="L282">			line = line.substring(line.indexOf(&quot; &quot;) + 1);</span>
<span class="nc" id="L283">			StringTokenizer tokenizer = new StringTokenizer(v3Tags);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">			while (tokenizer.hasMoreTokens()) {</span>
<span class="nc" id="L285">				String tag = tokenizer.nextToken(&quot;;&quot;);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">				if (tag.contains(&quot;=&quot;)) {</span>
<span class="nc" id="L287">					String[] parts = tag.split(&quot;=&quot;);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">					tags.put(parts[0], (parts.length == 2 ? parts[1] : &quot;&quot;));</span>
<span class="nc" id="L289">				} else {</span>
<span class="nc" id="L290">					tags.put(tag, &quot;&quot;);</span>
				}
<span class="nc" id="L292">			}</span>
		}
<span class="fc" id="L294">		List&lt;String&gt; parsedLine = Utils.tokenizeLine(line);</span>
<span class="fc" id="L295">		String sourceRaw = &quot;&quot;;</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">		if (parsedLine.get(0).charAt(0) == ':') sourceRaw = parsedLine.remove(0);</span>
<span class="fc" id="L297">		String command = parsedLine.remove(0).toUpperCase(configuration.getLocale());</span>
		// Check for server pings.
<span class="fc bfc" id="L299" title="All 2 branches covered.">		if (command.equals(&quot;PING&quot;)) {</span>
			// Respond to the ping and return immediately.
<span class="fc" id="L301">			configuration.getListenerManager().onEvent(new ServerPingEvent(bot, parsedLine.get(0)));</span>
<span class="fc" id="L302">			return;</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">		} else if (command.startsWith(&quot;ERROR&quot;)) {</span>
			//Server is shutting us down
<span class="fc" id="L305">			bot.close();</span>
<span class="fc" id="L306">			return;</span>
		}
<span class="fc bfc" id="L308" title="All 2 branches covered.">		String target = (parsedLine.isEmpty()) ? &quot;&quot; : parsedLine.get(0);</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">		if (target.startsWith(&quot;:&quot;)) target = target.substring(1);</span>
		//Make sure this is a valid IRC line
<span class="fc bfc" id="L311" title="All 2 branches covered.">		if (!sourceRaw.startsWith(&quot;:&quot;)) {</span>
			// We don't know what this line means.
<span class="fc" id="L313">			configuration.getListenerManager().onEvent(new UnknownEvent(bot, line));</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">			if (!bot.loggedIn) </span>
			//Pass to CapHandlers, could be important
<span class="pc bpc" id="L316" title="1 of 4 branches missed.">			for (CapHandler curCapHandler : configuration.getCapHandlers()) if (curCapHandler.handleUnknown(bot, line)) addCapHandlerFinished(curCapHandler);</span>
			//Do not continue
<span class="fc" id="L318">			return;</span>
		}
<span class="fc bfc" id="L320" title="All 2 branches covered.">		if (!bot.loggedIn) processConnect(line, command, target, parsedLine);</span>
		//Might be a backend code 
<span class="fc" id="L322">		int code = Utils.tryParseInt(command, -1);</span>
<span class="fc bfc" id="L323" title="All 2 branches covered.">		if (code != -1) {</span>
<span class="fc" id="L324">			processServerResponse(code, line, parsedLine);</span>
			//Do not continue
<span class="fc" id="L326">			return;</span>
		}
		//Must be from user
<span class="fc" id="L329">		UserHostmask source = bot.getConfiguration().getBotFactory().createUserHostmask(bot, sourceRaw.substring(1));</span>
<span class="fc" id="L330">		processCommand(target, source, command, line, parsedLine, tags.build());</span>
<span class="fc" id="L331">	}</span>

	/**
	 * Process any lines relevant to connect. Only called before bot is logged
	 * into the server
	 *
	 * @param rawLine Raw, unprocessed line from the server
	 * @param code
	 * @param target
	 * @param parsedLine Processed line
	 * @throws IrcException If the server rejects the bot (nick already in use
	 * or a 4** or 5** code
	 * @throws IOException If an error occurs during upgrading to SSL
	 */
	public void processConnect(String rawLine, String code, String target, List&lt;String&gt; parsedLine) throws IrcException, IOException {
<span class="fc bfc" id="L346" title="All 2 branches covered.">		if (CONNECT_CODES.contains(code)) {</span>
			// We're connected to the server.
<span class="fc" id="L348">			bot.onLoggedIn(parsedLine.get(0));</span>
<span class="fc" id="L349">			log.debug(&quot;Logged onto server.&quot;);</span>
<span class="fc" id="L350">			configuration.getListenerManager().onEvent(new ConnectEvent(bot));</span>
			//Handle automatic on connect stuff
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">			if (configuration.getNickservPassword() != null) bot.sendIRC().identify(configuration.getNickservPassword());</span>
<span class="fc" id="L353">			ImmutableMap&lt;String, String&gt; autoConnectChannels = bot.reconnectChannels();</span>
<span class="pc bpc" id="L354" title="2 of 4 branches missed.">			if (autoConnectChannels == null) if (configuration.isNickservDelayJoin()) autoConnectChannels = ImmutableMap.of(); else autoConnectChannels = configuration.getAutoJoinChannels();</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">			for (Map.Entry&lt;String, String&gt; channelEntry : autoConnectChannels.entrySet()) bot.sendIRC().joinChannel(channelEntry.getKey(), channelEntry.getValue());</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">		} else if (code.equals(&quot;439&quot;)) </span>
		//EXAMPLE: PircBotX: Target change too fast. Please wait 104 seconds
		// No action required.
		//TODO: Should we delay joining channels here or something?
<span class="pc bpc" id="L360" title="3 of 6 branches missed.">		log.warn(&quot;Ignoring too fast error&quot;); else if (configuration.isCapEnabled() &amp;&amp; code.equals(&quot;421&quot;) &amp;&amp; parsedLine.get(1).equals(&quot;CAP&quot;)) </span>
		//EXAMPLE: 421 you CAP :Unknown command
<span class="pc bpc" id="L362" title="3 of 6 branches missed.">		log.warn(&quot;Ignoring unknown command error, server does not support CAP negotiation&quot;); else if (configuration.isCapEnabled() &amp;&amp; code.equals(&quot;451&quot;) &amp;&amp; target.equals(&quot;CAP&quot;)) {</span>
			//EXAMPLE: 451 CAP :You have not registered
			//Ignore, this is from servers that don't support CAP
<span class="nc" id="L365">			log.warn(&quot;Ignoring not registered error, server does not support CAP negotiation&quot;);</span>
<span class="pc bpc" id="L366" title="3 of 6 branches missed.">		} else if (configuration.isCapEnabled() &amp;&amp; code.equals(&quot;410&quot;) &amp;&amp; rawLine.contains(&quot;CAP&quot;)) {</span>
			//EXAMPLE: 410 :Invalid CAP command
			//Ignore, Twitch.tv uses this code for some reason
<span class="nc" id="L369">			log.warn(&quot;Ignoring invalid command error, server does not support CAP negotiation&quot;);</span>
<span class="pc bpc" id="L370" title="2 of 6 branches missed.">		} else if ((code.startsWith(&quot;5&quot;) || code.startsWith(&quot;4&quot;)) &amp;&amp; !code.equals(&quot;433&quot;)) </span>
		//Ignore 433 NickAlreadyInUse, handled later
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">		throw new IrcException(IrcException.Reason.CannotLogin, &quot;Received error: &quot; + rawLine); else if (code.equals(&quot;670&quot;)) {</span>
			//Server is saying that we can upgrade to TLS
<span class="nc" id="L374">			log.debug(&quot;Upgrading to TLS connection&quot;);</span>
<span class="nc" id="L375">			SSLSocketFactory sslSocketFactory = ((SSLSocketFactory)SSLSocketFactory.getDefault());</span>
<span class="nc bnc" id="L376" title="All 4 branches missed.">			for (CapHandler curCapHandler : configuration.getCapHandlers()) if (curCapHandler instanceof TLSCapHandler) sslSocketFactory = ((TLSCapHandler)curCapHandler).getSslSocketFactory();</span>
<span class="nc" id="L377">			SSLSocket sslSocket = (SSLSocket)sslSocketFactory.createSocket(bot.getSocket(), bot.getLocalAddress().getHostAddress(), bot.getSocket().getPort(), true);</span>
<span class="nc" id="L378">			sslSocket.startHandshake();</span>
<span class="nc" id="L379">			bot.changeSocket(sslSocket);</span>
			//Notify CAP Handlers
<span class="nc bnc" id="L381" title="All 4 branches missed.">			for (CapHandler curCapHandler : configuration.getCapHandlers()) if (curCapHandler.handleUnknown(bot, rawLine)) addCapHandlerFinished(curCapHandler);</span>
<span class="pc bfc" id="L382" title="All 4 branches covered.">		} else if (code.equals(&quot;CAP&quot;) &amp;&amp; configuration.isCapEnabled()) {</span>
			//Handle CAP Code; remove extra from params
<span class="fc" id="L384">			String capCommand = parsedLine.get(1);</span>
<span class="fc" id="L385">			ImmutableList&lt;String&gt; capParams = ImmutableList.copyOf(StringUtils.split(parsedLine.get(2)));</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">			if (capCommand.equals(&quot;LS&quot;)) {</span>
<span class="fc" id="L387">				log.debug(&quot;Starting Cap Handlers {}&quot;, getCapHandlersRemaining());</span>
<span class="fc bfc" id="L388" title="All 2 branches covered.">				for (CapHandler curCapHandler : getCapHandlersRemaining()) {</span>
<span class="fc bfc" id="L389" title="All 2 branches covered.">					if (curCapHandler.handleLS(bot, capParams)) addCapHandlerFinished(curCapHandler);</span>
<span class="fc" id="L390">				}</span>
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">			} else if (capCommand.equals(&quot;ACK&quot;)) {</span>
				//Server is enabling a capability, store that
<span class="fc" id="L393">				bot.getEnabledCapabilities().addAll(capParams);</span>
<span class="fc bfc" id="L394" title="All 4 branches covered.">				for (CapHandler curCapHandler : getCapHandlersRemaining()) if (curCapHandler.handleACK(bot, capParams)) addCapHandlerFinished(curCapHandler);</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">			} else if (capCommand.equals(&quot;NAK&quot;)) {</span>
<span class="nc bnc" id="L396" title="All 4 branches missed.">				for (CapHandler curCapHandler : getCapHandlersRemaining()) if (curCapHandler.handleNAK(bot, capParams)) addCapHandlerFinished(curCapHandler);</span>
			} else {
				//Maybe the CapHandlers know how to use it
<span class="nc bnc" id="L399" title="All 4 branches missed.">				for (CapHandler curCapHandler : getCapHandlersRemaining()) if (curCapHandler.handleUnknown(bot, rawLine)) addCapHandlerFinished(curCapHandler);</span>
			}
<span class="fc" id="L401">		} else </span>
		//Pass to CapHandlers, could be important
<span class="fc bfc" id="L403" title="All 4 branches covered.">		for (CapHandler curCapHandler : getCapHandlersRemaining()) if (curCapHandler.handleUnknown(bot, rawLine)) addCapHandlerFinished(curCapHandler);</span>
<span class="fc" id="L404">	}</span>

	protected List&lt;CapHandler&gt; getCapHandlersRemaining() {
<span class="fc" id="L407">		List&lt;CapHandler&gt; remaining = Lists.newArrayList(configuration.getCapHandlers());</span>
<span class="fc" id="L408">		remaining.removeAll(capHandlersFinished);</span>
<span class="fc" id="L409">		return remaining;</span>
	}

	protected void addCapHandlerFinished(CapHandler capHandler) {
<span class="fc" id="L413">		log.debug(&quot;Cap Handler finished &quot; + capHandler);</span>
<span class="fc" id="L414">		capHandlersFinished.add(capHandler);</span>
<span class="pc bpc" id="L415" title="1 of 4 branches missed.">		if (!capEndSent &amp;&amp; capHandlersFinished.size() == configuration.getCapHandlers().size()) {</span>
<span class="fc" id="L416">			capEndSent = true;</span>
<span class="fc" id="L417">			bot.sendCAP().end();</span>
<span class="fc" id="L418">			bot.enabledCapabilities = Collections.unmodifiableList(bot.enabledCapabilities);</span>
		}
<span class="fc" id="L420">	}</span>

	public void processCommand(String target, UserHostmask source, String command, String line, List&lt;String&gt; parsedLine, ImmutableMap&lt;String, String&gt; tags) throws IOException {
		//If the channel matches a prefix, then its a channel
<span class="fc bfc" id="L424" title="All 4 branches covered.">		Channel channel = (target.length() != 0 &amp;&amp; bot.getUserChannelDao().containsChannel(target)) ? bot.getUserChannelDao().getChannel(target) : null;</span>
<span class="fc bfc" id="L425" title="All 2 branches covered.">		String message = parsedLine.size() &gt;= 2 ? parsedLine.get(1) : &quot;&quot;;</span>
		//Try to load the source user if it exists
<span class="fc bfc" id="L427" title="All 2 branches covered.">		User sourceUser = bot.getUserChannelDao().containsUser(source) ? bot.getUserChannelDao().getUser(source) : null;</span>
		// Check for CTCP requests.
<span class="pc bpc" id="L429" title="1 of 6 branches missed.">		if (command.equals(&quot;PRIVMSG&quot;) &amp;&amp; message.startsWith(&quot;\001&quot;) &amp;&amp; message.endsWith(&quot;\001&quot;)) {</span>
<span class="fc" id="L430">			sourceUser = createUserIfNull(sourceUser, source);</span>
<span class="fc" id="L431">			String request = message.substring(1, message.length() - 1);</span>
<span class="fc bfc" id="L432" title="All 2 branches covered.">			if (request.equals(&quot;VERSION&quot;)) </span>
			// VERSION request
<span class="fc bfc" id="L434" title="All 2 branches covered.">			configuration.getListenerManager().onEvent(new VersionEvent(bot, source, sourceUser, channel)); else if (request.startsWith(&quot;ACTION &quot;)) </span>
			// ACTION request
<span class="fc bfc" id="L436" title="All 2 branches covered.">			configuration.getListenerManager().onEvent(new ActionEvent(bot, source, sourceUser, channel, target, request.substring(7))); else if (request.startsWith(&quot;PING &quot;)) </span>
			// PING request
<span class="fc bfc" id="L438" title="All 2 branches covered.">			configuration.getListenerManager().onEvent(new PingEvent(bot, source, sourceUser, channel, request.substring(5))); else if (request.equals(&quot;TIME&quot;)) </span>
			// TIME request
<span class="fc bfc" id="L440" title="All 2 branches covered.">			configuration.getListenerManager().onEvent(new TimeEvent(bot, channel, source, sourceUser)); else if (request.equals(&quot;FINGER&quot;)) </span>
			// FINGER request
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">			configuration.getListenerManager().onEvent(new FingerEvent(bot, source, sourceUser, channel)); else if (request.startsWith(&quot;DCC &quot;)) {</span>
				// This is a DCC request.
<span class="fc" id="L444">				boolean success = bot.getDccHandler().processDcc(source, sourceUser, request);</span>
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">				if (!success) </span>
				// The DccManager didn't know what to do with the line.
<span class="nc" id="L447">				configuration.getListenerManager().onEvent(new UnknownEvent(bot, line));</span>
<span class="fc" id="L448">			} else </span>
			// An unknown CTCP message - ignore it.
<span class="nc" id="L450">			configuration.getListenerManager().onEvent(new UnknownEvent(bot, line));</span>
<span class="fc bfc" id="L451" title="All 4 branches covered.">		} else if (command.equals(&quot;PRIVMSG&quot;) &amp;&amp; channel != null) {</span>
			// This is a normal message to a channel.
<span class="fc" id="L453">			sourceUser = createUserIfNull(sourceUser, source);</span>
<span class="fc" id="L454">			configuration.getListenerManager().onEvent(new MessageEvent(bot, channel, target, source, sourceUser, message, tags));</span>
<span class="fc bfc" id="L455" title="All 2 branches covered.">		} else if (command.equals(&quot;PRIVMSG&quot;)) {</span>
			// This is a private message to us.
			//Add to private message
<span class="fc" id="L458">			sourceUser = createUserIfNull(sourceUser, source);</span>
<span class="fc" id="L459">			bot.getUserChannelDao().addUserToPrivate(sourceUser);</span>
<span class="fc" id="L460">			configuration.getListenerManager().onEvent(new PrivateMessageEvent(bot, source, sourceUser, message));</span>
<span class="fc bfc" id="L461" title="All 2 branches covered.">		} else if (command.equals(&quot;JOIN&quot;)) {</span>
			// Someone is joining a channel.
<span class="fc bfc" id="L463" title="All 2 branches covered.">			if (source.getNick().equalsIgnoreCase(bot.getNick())) {</span>
				//Its us, get channel info
<span class="fc" id="L465">				channel = bot.getUserChannelDao().createChannel(target);</span>
<span class="fc bfc" id="L466" title="All 2 branches covered.">				if (configuration.isOnJoinWhoEnabled()) bot.sendRaw().rawLine(&quot;WHO &quot; + target);</span>
<span class="fc" id="L467">				bot.sendRaw().rawLine(&quot;MODE &quot; + target);</span>
			}
			//Create user if it doesn't exist already
<span class="fc" id="L470">			sourceUser = createUserIfNull(sourceUser, source);</span>
<span class="fc" id="L471">			bot.getUserChannelDao().addUserToChannel(sourceUser, channel);</span>
<span class="fc" id="L472">			configuration.getListenerManager().onEvent(new JoinEvent(bot, channel, source, sourceUser));</span>
<span class="fc bfc" id="L473" title="All 2 branches covered.">		} else if (command.equals(&quot;PART&quot;)) {</span>
			// Someone is parting from a channel.
			UserChannelDaoSnapshot daoSnapshot;
			ChannelSnapshot channelSnapshot;
			UserSnapshot sourceSnapshot;
<span class="pc bpc" id="L478" title="1 of 2 branches missed.">			if (configuration.isSnapshotsEnabled()) {</span>
<span class="fc" id="L479">				daoSnapshot = bot.getUserChannelDao().createSnapshot();</span>
<span class="fc" id="L480">				channelSnapshot = daoSnapshot.getChannel(channel.getName());</span>
<span class="fc" id="L481">				sourceSnapshot = daoSnapshot.getUser(source);</span>
			} else {
<span class="nc" id="L483">				daoSnapshot = null;</span>
<span class="nc" id="L484">				channelSnapshot = null;</span>
<span class="nc" id="L485">				sourceSnapshot = null;</span>
			}
<span class="pc bpc" id="L487" title="1 of 2 branches missed.">			if (source.getNick().equalsIgnoreCase(bot.getNick())) </span>
			//We parted the channel
<span class="nc" id="L489">			bot.getUserChannelDao().removeChannel(channel); else </span>
			//Just remove the user from memory
<span class="fc" id="L491">			bot.getUserChannelDao().removeUserFromChannel(sourceUser, channel);</span>
<span class="fc" id="L492">			configuration.getListenerManager().onEvent(new PartEvent(bot, daoSnapshot, channelSnapshot, source, sourceSnapshot, message));</span>
<span class="fc bfc" id="L493" title="All 2 branches covered.">		} else if (command.equals(&quot;NICK&quot;)) {</span>
			// Somebody is changing their nick.
<span class="fc" id="L495">			sourceUser = createUserIfNull(sourceUser, source);</span>
<span class="fc" id="L496">			String newNick = target;</span>
<span class="fc" id="L497">			bot.getUserChannelDao().renameUser(sourceUser, newNick);</span>
<span class="fc bfc" id="L498" title="All 2 branches covered.">			if (source.getNick().equals(bot.getNick())) </span>
			// Update our nick if it was us that changed nick.
<span class="fc" id="L500">			bot.setNick(newNick);</span>
<span class="fc" id="L501">			configuration.getListenerManager().onEvent(new NickChangeEvent(bot, source.getNick(), newNick, source, sourceUser));</span>
<span class="fc bfc" id="L502" title="All 2 branches covered.">		} else if (command.equals(&quot;NOTICE&quot;)) {</span>
			// Someone is sending a notice.
<span class="fc" id="L504">			configuration.getListenerManager().onEvent(new NoticeEvent(bot, source, sourceUser, channel, target, message));</span>
<span class="fc bfc" id="L505" title="All 2 branches covered.">		} else if (command.equals(&quot;QUIT&quot;)) {</span>
			UserChannelDaoSnapshot daoSnapshot;
			UserSnapshot sourceSnapshot;
<span class="pc bpc" id="L508" title="1 of 2 branches missed.">			if (configuration.isSnapshotsEnabled()) {</span>
<span class="fc" id="L509">				daoSnapshot = bot.getUserChannelDao().createSnapshot();</span>
<span class="fc" id="L510">				sourceSnapshot = daoSnapshot.getUser(sourceUser.getNick());</span>
			} else {
<span class="nc" id="L512">				daoSnapshot = null;</span>
<span class="nc" id="L513">				sourceSnapshot = null;</span>
			}
			//A real target is missing, so index is off
<span class="fc" id="L516">			String reason = target;</span>
			// Someone has quit from the IRC server.
<span class="pc bpc" id="L518" title="1 of 2 branches missed.">			if (!source.getNick().equals(bot.getNick())) </span>
			//Someone else
<span class="fc" id="L520">			bot.getUserChannelDao().removeUser(sourceUser);</span>
<span class="fc" id="L521">			configuration.getListenerManager().onEvent(new QuitEvent(bot, daoSnapshot, source, sourceSnapshot, reason));</span>
<span class="fc bfc" id="L522" title="All 2 branches covered.">		} else if (command.equals(&quot;KICK&quot;)) {</span>
			// Somebody has been kicked from a channel.
<span class="fc" id="L524">			UserHostmask recipientHostmask = bot.getConfiguration().getBotFactory().createUserHostmask(bot, message);</span>
<span class="fc" id="L525">			User recipient = bot.getUserChannelDao().getUser(message);</span>
<span class="pc bpc" id="L526" title="1 of 2 branches missed.">			if (recipient.getNick().equals(bot.getNick())) </span>
			//We were just kicked
<span class="nc" id="L528">			bot.getUserChannelDao().removeChannel(channel); else </span>
			//Someone else
<span class="fc" id="L530">			bot.getUserChannelDao().removeUserFromChannel(recipient, channel);</span>
<span class="fc" id="L531">			configuration.getListenerManager().onEvent(new KickEvent(bot, channel, source, sourceUser, recipientHostmask, recipient, parsedLine.get(2)));</span>
<span class="fc bfc" id="L532" title="All 2 branches covered.">		} else if (command.equals(&quot;MODE&quot;)) {</span>
			// Somebody is changing the mode on a channel or user (Use long form since mode isn't after a : )
<span class="fc" id="L534">			String mode = line.substring(line.indexOf(target, 2) + target.length() + 1);</span>
<span class="fc bfc" id="L535" title="All 2 branches covered.">			if (mode.startsWith(&quot;:&quot;)) mode = mode.substring(1);</span>
			//TODO: ummm... what does this do?
			//Handle situations where source doesn't have a full username (IE server setting user mode on connect)
			//User sourceModeUser = sourceUser;
			//if (sourceModeUser == null)
			//	sourceModeUser = bot.getUserChannelDao().getUser(source);
<span class="fc" id="L541">			processMode(source, sourceUser, target, mode);</span>
<span class="fc bfc" id="L542" title="All 2 branches covered.">		} else if (command.equals(&quot;TOPIC&quot;)) {</span>
			// Someone is changing the topic.
<span class="fc" id="L544">			long currentTime = System.currentTimeMillis();</span>
<span class="fc" id="L545">			String oldTopic = channel.getTopic();</span>
<span class="fc" id="L546">			channel.setTopic(message);</span>
<span class="fc" id="L547">			channel.setTopicSetter(source);</span>
<span class="fc" id="L548">			channel.setTopicTimestamp(currentTime);</span>
<span class="fc" id="L549">			configuration.getListenerManager().onEvent(new TopicEvent(bot, channel, oldTopic, message, source, currentTime, true));</span>
<span class="fc bfc" id="L550" title="All 2 branches covered.">		} else if (command.equals(&quot;INVITE&quot;)) {</span>
			// Somebody is inviting somebody else into a channel.
<span class="fc" id="L552">			configuration.getListenerManager().onEvent(new InviteEvent(bot, source, sourceUser, message));</span>
<span class="fc bfc" id="L553" title="All 2 branches covered.">		} else if (command.equals(&quot;AWAY&quot;)) </span>
		//IRCv3 AWAY notify
<span class="fc bfc" id="L555" title="All 2 branches covered.">		if (parsedLine.isEmpty()) sourceUser.setAwayMessage(&quot;&quot;); else sourceUser.setAwayMessage(parsedLine.get(0)); else </span>
		// If we reach this point, then we've found something that the PircBotX
		// Doesn't currently deal with.
<span class="fc" id="L558">		configuration.getListenerManager().onEvent(new UnknownEvent(bot, line));</span>
<span class="fc" id="L559">	}</span>

	/**
	 * This method is called by the PircBotX when a numeric response is received
	 * from the IRC server. We use this method to allow PircBotX to process
	 * various responses from the server before then passing them on to the
	 * onServerResponse method.
	 * &lt;p&gt;
	 * Note that this method is private and should not appear in any of the
	 * javadoc generated documentation.
	 *
	 * @param code The three-digit numerical code for the response.
	 */
	public void processServerResponse(int code, String rawResponse, List&lt;String&gt; parsedResponseOrig) {
<span class="fc" id="L573">		ImmutableList&lt;String&gt; parsedResponse = ImmutableList.copyOf(parsedResponseOrig);</span>
		//Parsed response format: Everything after code
<span class="fc bfc" id="L575" title="All 2 branches covered.">		if (code == 433) {</span>
			//EXAMPLE: * AnAlreadyUsedName :Nickname already in use
			//EXAMPLE: AnAlreadyUsedName :Nickname already in use (spec)
			//TODO: When output parsing is implemented intercept outgoing NICK?
			//Nickname in use, rename
<span class="fc" id="L580">			boolean autoNickChange = configuration.isAutoNickChange();</span>
<span class="fc" id="L581">			String autoNewNick = null;</span>
<span class="fc" id="L582">			String usedNick = null;</span>
<span class="fc" id="L583">			boolean doAutoNickChange = false;</span>
			//Ignore cases where we already have a valid nick but changed to a used one
<span class="fc bfc" id="L585" title="All 2 branches covered.">			if (parsedResponse.size() == 3) {</span>
<span class="fc" id="L586">				usedNick = parsedResponse.get(1);</span>
<span class="fc bfc" id="L587" title="All 2 branches covered.">				if (parsedResponse.get(0).equals(&quot;*&quot;)) {</span>
<span class="fc" id="L588">					doAutoNickChange = true;</span>
				}
			} //For spec-compilant servers, if were not logged in its safe to assume we don't have a valid nick on connect
			 else {
<span class="fc" id="L592">				usedNick = parsedResponse.get(0);</span>
<span class="fc bfc" id="L593" title="All 2 branches covered.">				if (!bot.loggedIn) {</span>
<span class="fc" id="L594">					doAutoNickChange = true;</span>
				}
			}
<span class="pc bpc" id="L597" title="1 of 4 branches missed.">			if (autoNickChange &amp;&amp; doAutoNickChange) {</span>
<span class="fc" id="L598">				nickSuffix++;</span>
<span class="fc" id="L599">				autoNewNick = configuration.getName() + nickSuffix;</span>
<span class="fc" id="L600">				bot.sendIRC().changeNick(autoNewNick);</span>
<span class="fc" id="L601">				bot.setNick(autoNewNick);</span>
<span class="fc" id="L602">				bot.getUserChannelDao().renameUser(bot.getUserChannelDao().getUser(usedNick), autoNewNick);</span>
			}
<span class="fc" id="L604">			configuration.getListenerManager().onEvent(new NickAlreadyInUseEvent(bot, usedNick, autoNewNick, autoNickChange));</span>
<span class="fc bfc" id="L605" title="All 2 branches covered.">		} else if (code == RPL_LISTSTART) {</span>
			//EXAMPLE: 321 Channel :Users Name (actual text)
			//A channel list is about to be sent
<span class="fc" id="L608">			channelListBuilder = ImmutableList.builder();</span>
<span class="fc" id="L609">			channelListRunning = true;</span>
<span class="fc bfc" id="L610" title="All 2 branches covered.">		} else if (code == RPL_LIST) {</span>
			//This is part of a full channel listing as part of /LIST
			//EXAMPLE: 322 lordquackstar #xomb 12 :xomb exokernel project @ www.xomb.org
<span class="fc" id="L613">			String channel = parsedResponse.get(1);</span>
<span class="fc" id="L614">			int userCount = Utils.tryParseInt(parsedResponse.get(2), -1);</span>
<span class="fc" id="L615">			String topic = parsedResponse.get(3);</span>
<span class="fc" id="L616">			channelListBuilder.add(new ChannelListEntry(channel, userCount, topic));</span>
<span class="fc bfc" id="L617" title="All 2 branches covered.">		} else if (code == RPL_LISTEND) {</span>
			//EXAMPLE: 323 :End of /LIST
			//End of channel list, dispatch event
<span class="fc" id="L620">			configuration.getListenerManager().onEvent(new ChannelInfoEvent(bot, channelListBuilder.build()));</span>
<span class="fc" id="L621">			channelListBuilder = null;</span>
<span class="fc" id="L622">			channelListRunning = false;</span>
<span class="fc bfc" id="L623" title="All 2 branches covered.">		} else if (code == RPL_TOPIC) {</span>
			//EXAMPLE: 332 PircBotX #aChannel :I'm some random topic
			//This is topic about a channel we've just joined. From /JOIN or /TOPIC
<span class="fc" id="L626">			Channel channel = bot.getUserChannelDao().getChannel(parsedResponse.get(1));</span>
<span class="fc" id="L627">			String topic = parsedResponse.get(2);</span>
<span class="fc" id="L628">			channel.setTopic(topic);</span>
<span class="fc bfc" id="L629" title="All 2 branches covered.">		} else if (code == RPL_TOPICINFO) {</span>
			//EXAMPLE: 333 PircBotX #aChannel ISetTopic 1564842512
			//This is information on the topic of the channel we've just joined. From /JOIN or /TOPIC
<span class="fc" id="L632">			Channel channel = bot.getUserChannelDao().getChannel(parsedResponse.get(1));</span>
<span class="fc" id="L633">			UserHostmask setBy = configuration.getBotFactory().createUserHostmask(bot, parsedResponse.get(2));</span>
<span class="fc" id="L634">			long date = Utils.tryParseLong(parsedResponse.get(3), -1);</span>
<span class="fc" id="L635">			channel.setTopicTimestamp(date * 1000);</span>
<span class="fc" id="L636">			channel.setTopicSetter(setBy);</span>
<span class="fc" id="L637">			configuration.getListenerManager().onEvent(new TopicEvent(bot, channel, null, channel.getTopic(), setBy, date, false));</span>
<span class="fc bfc" id="L638" title="All 2 branches covered.">		} else if (code == RPL_WHOREPLY) {</span>
			//EXAMPLE: 352 PircBotX #aChannel ~someName 74.56.56.56.my.Hostmask wolfe.freenode.net someNick H :0 Full Name
			//Part of a WHO reply on information on individual users
<span class="fc" id="L641">			Channel channel = bot.getUserChannelDao().getChannel(parsedResponse.get(1));</span>
			//Setup user
<span class="fc" id="L643">			String nick = parsedResponse.get(5);</span>
<span class="pc bpc" id="L644" title="1 of 2 branches missed.">			User curUser = bot.getUserChannelDao().containsUser(nick) ? bot.getUserChannelDao().getUser(nick) : null;</span>
<span class="fc" id="L645">			UserHostmask curUserHostmask = bot.getConfiguration().getBotFactory().createUserHostmask(bot, null, nick, parsedResponse.get(2), parsedResponse.get(3));</span>
<span class="fc" id="L646">			curUser = createUserIfNull(curUser, curUserHostmask);</span>
<span class="fc" id="L647">			curUser.setServer(parsedResponse.get(4));</span>
<span class="fc" id="L648">			processUserStatus(channel, curUser, parsedResponse.get(6));</span>
			//Extra parsing needed since tokenizer stopped at :
<span class="fc" id="L650">			String rawEnding = parsedResponse.get(7);</span>
<span class="fc" id="L651">			int rawEndingSpaceIndex = rawEnding.indexOf(' ');</span>
<span class="fc bfc" id="L652" title="All 2 branches covered.">			if (rawEndingSpaceIndex == -1) {</span>
				//parsedResponse data is trimmed, so if the index == -1, then there was no real name given and the space separating hops from real name was trimmed.
<span class="fc" id="L654">				curUser.setHops(Integer.parseInt(rawEnding));</span>
<span class="fc" id="L655">				curUser.setRealName(&quot;&quot;);</span>
			} else {
				//parsedResponse data contains a real name
<span class="fc" id="L658">				curUser.setHops(Integer.parseInt(rawEnding.substring(0, rawEndingSpaceIndex)));</span>
<span class="fc" id="L659">				curUser.setRealName(rawEnding.substring(rawEndingSpaceIndex + 1));</span>
			}
			//Associate with channel
<span class="fc" id="L662">			bot.getUserChannelDao().addUserToChannel(curUser, channel);</span>
<span class="fc bfc" id="L663" title="All 2 branches covered.">		} else if (code == RPL_ENDOFWHO) {</span>
			//EXAMPLE: 315 PircBotX #aChannel :End of /WHO list
			//End of the WHO reply
<span class="fc" id="L666">			Channel channel = bot.getUserChannelDao().getChannel(parsedResponse.get(1));</span>
<span class="fc" id="L667">			configuration.getListenerManager().onEvent(new UserListEvent(bot, channel, bot.getUserChannelDao().getUsers(channel), true));</span>
<span class="fc bfc" id="L668" title="All 2 branches covered.">		} else if (code == RPL_CHANNELMODEIS) {</span>
			//EXAMPLE: 324 PircBotX #aChannel +cnt
			//Full channel mode (In response to MODE &lt;channel&gt;)
<span class="fc" id="L671">			Channel channel = bot.getUserChannelDao().getChannel(parsedResponse.get(1));</span>
<span class="fc" id="L672">			ImmutableList&lt;String&gt; modeParsed = parsedResponse.subList(2, parsedResponse.size());</span>
<span class="fc" id="L673">			String mode = StringUtils.join(modeParsed, ' ');</span>
<span class="fc" id="L674">			channel.setMode(mode, modeParsed);</span>
<span class="fc" id="L675">			configuration.getListenerManager().onEvent(new ModeEvent(bot, channel, null, null, mode, modeParsed));</span>
<span class="fc bfc" id="L676" title="All 2 branches covered.">		} else if (code == 329) {</span>
			//EXAMPLE: 329 lordquackstar #botters 1199140245
			//Tells when channel was created. From /JOIN
<span class="fc" id="L679">			Channel channel = bot.getUserChannelDao().getChannel(parsedResponse.get(1));</span>
<span class="fc" id="L680">			int createDate = Utils.tryParseInt(parsedResponse.get(2), -1);</span>
			//Set in channel
<span class="fc" id="L682">			channel.setCreateTimestamp(createDate);</span>
<span class="fc bfc" id="L683" title="All 2 branches covered.">		} else if (code == RPL_MOTDSTART) </span>
		//Example: 375 PircBotX :- wolfe.freenode.net Message of the Day -
		//Motd is starting, reset the StringBuilder
<span class="fc bfc" id="L686" title="All 2 branches covered.">		motdBuilder = new StringBuilder(); else if (code == RPL_MOTD) </span>
		//Example: 372 PircBotX :- Welcome to wolfe.freenode.net in Manchester, England, Uk!  Thanks to
		//This is part of the MOTD, add a new line
<span class="fc bfc" id="L689" title="All 2 branches covered.">		motdBuilder.append(CharMatcher.WHITESPACE.trimFrom(parsedResponse.get(1).substring(1))).append(&quot;\n&quot;); else if (code == RPL_ENDOFMOTD) {</span>
			//Example: PircBotX :End of /MOTD command.
			//End of MOTD, clean it and dispatch MotdEvent
<span class="fc" id="L692">			ServerInfo serverInfo = bot.getServerInfo();</span>
<span class="fc" id="L693">			serverInfo.setMotd(motdBuilder.toString().trim());</span>
<span class="fc" id="L694">			motdBuilder = null;</span>
<span class="fc" id="L695">			configuration.getListenerManager().onEvent(new MotdEvent(bot, serverInfo.getMotd()));</span>
<span class="fc bfc" id="L696" title="All 4 branches covered.">		} else if (code == 4 || code == 5) {</span>
			//Example: 004 PircBotX sendak.freenode.net ircd-seven-1.1.3 DOQRSZaghilopswz CFILMPQbcefgijklmnopqrstvz bkloveqjfI
			//Server info line, remove ending comment and let ServerInfo class parse it
<span class="fc" id="L699">			int endCommentIndex = rawResponse.lastIndexOf(&quot; :&quot;);</span>
<span class="fc bfc" id="L700" title="All 2 branches covered.">			if (endCommentIndex &gt; 1) {</span>
<span class="fc" id="L701">				String endComment = rawResponse.substring(endCommentIndex + 2);</span>
<span class="fc" id="L702">				int lastIndex = parsedResponseOrig.size() - 1;</span>
<span class="pc bpc" id="L703" title="1 of 2 branches missed.">				if (endComment.equals(parsedResponseOrig.get(lastIndex))) parsedResponseOrig.remove(lastIndex);</span>
			}
<span class="fc" id="L705">			bot.getServerInfo().parse(code, parsedResponseOrig);</span>
<span class="fc bfc" id="L706" title="All 2 branches covered.">		} else if (code == RPL_WHOISUSER) {</span>
			//Example: 311 TheLQ Plazma ~Plazma freenode/staff/plazma * :Plazma Rooolz!
			//New whois is starting
<span class="fc" id="L709">			String whoisNick = parsedResponse.get(1);</span>
<span class="fc" id="L710">			WhoisEvent.Builder builder = WhoisEvent.builder();</span>
<span class="fc" id="L711">			builder.nick(whoisNick);</span>
<span class="fc" id="L712">			builder.login(parsedResponse.get(2));</span>
<span class="fc" id="L713">			builder.hostname(parsedResponse.get(3));</span>
<span class="fc" id="L714">			builder.realname(parsedResponse.get(5));</span>
<span class="fc" id="L715">			whoisBuilder.put(whoisNick, builder);</span>
<span class="fc bfc" id="L716" title="All 2 branches covered.">		} else if (code == RPL_AWAY) {</span>
			//Example: 301 PircBotXUser TheLQ_ :I'm away, sorry
			//Can be sent during whois
<span class="fc" id="L719">			String nick = parsedResponse.get(1);</span>
<span class="fc" id="L720">			String awayMessage = parsedResponse.get(2);</span>
<span class="pc bpc" id="L721" title="1 of 2 branches missed.">			if (bot.getUserChannelDao().containsUser(nick)) bot.getUserChannelDao().getUser(nick).setAwayMessage(awayMessage);</span>
<span class="pc bpc" id="L722" title="1 of 2 branches missed.">			if (whoisBuilder.containsKey(nick)) whoisBuilder.get(nick).awayMessage(awayMessage);</span>
<span class="fc bfc" id="L723" title="All 2 branches covered.">		} else if (code == RPL_WHOISCHANNELS) {</span>
			//Example: 319 TheLQ Plazma :+#freenode
			//Channel list from whois. Re-tokenize since they're after the :
<span class="fc" id="L726">			String whoisNick = parsedResponse.get(1);</span>
<span class="fc" id="L727">			ImmutableList&lt;String&gt; parsedChannels = ImmutableList.copyOf(Utils.tokenizeLine(parsedResponse.get(2)));</span>
<span class="fc" id="L728">			whoisBuilder.get(whoisNick).channels(parsedChannels);</span>
<span class="fc bfc" id="L729" title="All 2 branches covered.">		} else if (code == RPL_WHOISSERVER) {</span>
			//Server info from whois
			//312 TheLQ Plazma leguin.freenode.net :Ume?, SE, EU
<span class="fc" id="L732">			String whoisNick = parsedResponse.get(1);</span>
<span class="fc" id="L733">			whoisBuilder.get(whoisNick).server(parsedResponse.get(2));</span>
<span class="fc" id="L734">			whoisBuilder.get(whoisNick).serverInfo(parsedResponse.get(3));</span>
<span class="fc bfc" id="L735" title="All 2 branches covered.">		} else if (code == RPL_WHOISIDLE) {</span>
			//Idle time from whois
			//317 TheLQ md_5 6077 1347373349 :seconds idle, signon time
<span class="fc" id="L738">			String whoisNick = parsedResponse.get(1);</span>
<span class="fc" id="L739">			whoisBuilder.get(whoisNick).idleSeconds(Long.parseLong(parsedResponse.get(2)));</span>
<span class="fc" id="L740">			whoisBuilder.get(whoisNick).signOnTime(Long.parseLong(parsedResponse.get(3)));</span>
<span class="fc bfc" id="L741" title="All 2 branches covered.">		} else if (code == 330) {</span>
			//RPL_WHOISACCOUNT: Extra Whois info
			//330 TheLQ Utoxin Utoxin :is logged in as
			//Make sure we set registered as to the nick, not to the note after the colon
<span class="fc" id="L745">			String registeredNick = &quot;&quot;;</span>
<span class="fc bfc" id="L746" title="All 2 branches covered.">			if (!rawResponse.endsWith(&quot;:&quot; + parsedResponse.get(2))) registeredNick = parsedResponse.get(2);</span>
<span class="fc" id="L747">			whoisBuilder.get(parsedResponse.get(1)).registeredAs(registeredNick);</span>
<span class="fc bfc" id="L748" title="All 2 branches covered.">		} else if (code == 307) {</span>
			//If shown, tells us that the user is registered with nickserv
			//307 TheLQ TheLQ-PircBotX :has identified for this nick
<span class="fc" id="L751">			whoisBuilder.get(parsedResponse.get(1)).registeredAs(&quot;&quot;);</span>
<span class="fc bfc" id="L752" title="All 2 branches covered.">		} else if (code == ERR_NOSUCHSERVER) {</span>
			//Whois failed when doing &quot;WHOIS invaliduser invaliduser&quot;
			//402 TheLQ asdfasdf :No such server
<span class="fc" id="L755">			String whoisNick = parsedResponse.get(1);</span>
<span class="fc" id="L756">			WhoisEvent event = WhoisEvent.builder().nick(whoisNick).exists(false).generateEvent(bot);</span>
<span class="fc" id="L757">			configuration.getListenerManager().onEvent(event);</span>
<span class="fc bfc" id="L758" title="All 2 branches covered.">		} else if (code == RPL_ENDOFWHOIS) {</span>
			//End of whois
			//318 TheLQ Plazma :End of /WHOIS list.
<span class="fc" id="L761">			String whoisNick = parsedResponse.get(1);</span>
			WhoisEvent.Builder builder;
<span class="fc bfc" id="L763" title="All 2 branches covered.">			if (whoisBuilder.containsKey(whoisNick)) {</span>
<span class="fc" id="L764">				builder = whoisBuilder.get(whoisNick);</span>
<span class="fc" id="L765">				builder.exists(true);</span>
			} else {
<span class="fc" id="L767">				builder = WhoisEvent.builder();</span>
<span class="fc" id="L768">				builder.nick(whoisNick);</span>
<span class="fc" id="L769">				builder.exists(false);</span>
			}
<span class="fc" id="L771">			configuration.getListenerManager().onEvent(builder.generateEvent(bot));</span>
<span class="fc" id="L772">			whoisBuilder.remove(whoisNick);</span>
<span class="fc bfc" id="L773" title="All 2 branches covered.">		} else if (code == 367) {</span>
			//Ban list entry
			//367 TheLQ #aChannel *!*@test1.host TheLQ!~quackstar@some.host 1415143822
<span class="fc" id="L776">			Channel channel = bot.getUserChannelDao().getChannel(parsedResponse.get(1));</span>
<span class="fc" id="L777">			UserHostmask recipient = bot.getConfiguration().getBotFactory().createUserHostmask(bot, parsedResponse.get(2));</span>
<span class="fc" id="L778">			UserHostmask source = bot.getConfiguration().getBotFactory().createUserHostmask(bot, parsedResponse.get(3));</span>
<span class="fc" id="L779">			long time = Long.parseLong(parsedResponse.get(4));</span>
<span class="fc" id="L780">			banListBuilder.put(channel, new BanListEvent.Entry(recipient, source, time));</span>
<span class="fc" id="L781">			log.debug(&quot;Adding entry&quot;);</span>
<span class="fc bfc" id="L782" title="All 2 branches covered.">		} else if (code == 368) {</span>
			//Ban list is finished
			//368 TheLQ #aChannel :End of Channel Ban List
<span class="fc" id="L785">			Channel channel = bot.getUserChannelDao().getChannel(parsedResponse.get(1));</span>
<span class="fc" id="L786">			ImmutableList&lt;BanListEvent.Entry&gt; entries = ImmutableList.copyOf(banListBuilder.removeAll(channel));</span>
<span class="fc" id="L787">			log.debug(&quot;Dispatching event&quot;);</span>
<span class="fc" id="L788">			configuration.getListenerManager().onEvent(new BanListEvent(bot, channel, entries));</span>
<span class="fc bfc" id="L789" title="All 2 branches covered.">		} else if (code == 353) {</span>
			//NAMES response
			//353 PircBotXUser = #aChannel :aUser1 aUser2
<span class="fc bfc" id="L792" title="All 2 branches covered.">			for (String curUser : StringUtils.split(parsedResponse.get(3))) {</span>
				//Siphon off any levels this user has
<span class="fc" id="L794">				String nick = curUser;</span>
<span class="fc" id="L795">				List&lt;UserLevel&gt; levels = Lists.newArrayList();</span>
				UserLevel parsedLevel;
<span class="fc bfc" id="L797" title="All 2 branches covered.">				while ((parsedLevel = UserLevel.fromSymbol(nick.charAt(0))) != null) {</span>
<span class="fc" id="L798">					nick = nick.substring(1);</span>
<span class="fc" id="L799">					levels.add(parsedLevel);</span>
				}
				User user;
<span class="pc bpc" id="L802" title="1 of 2 branches missed.">				if (!bot.getUserChannelDao().containsUser(nick)) </span>
				//Create user with nick only
<span class="pc" id="L804">				user = bot.getUserChannelDao().createUser(new UserHostmask(bot, nick)); else user = bot.getUserChannelDao().getUser(nick);</span>
<span class="fc" id="L805">				Channel chan = bot.getUserChannelDao().getChannel(parsedResponse.get(2));</span>
<span class="fc" id="L806">				bot.getUserChannelDao().addUserToChannel(user, chan);</span>
				//Now that the user is created, add them to the appropiate levels
<span class="fc bfc" id="L808" title="All 2 branches covered.">				for (UserLevel curLevel : levels) {</span>
<span class="fc" id="L809">					bot.getUserChannelDao().addUserToLevel(curLevel, user, chan);</span>
<span class="fc" id="L810">				}</span>
			}
<span class="fc bfc" id="L812" title="All 2 branches covered.">		} else if (code == 366) {</span>
			//NAMES response finished
			//366 PircBotXUser #aChannel :End of /NAMES list.
<span class="fc" id="L815">			Channel channel = bot.getUserChannelDao().getChannel(parsedResponse.get(1));</span>
<span class="fc" id="L816">			configuration.getListenerManager().onEvent(new UserListEvent(bot, channel, bot.getUserChannelDao().getUsers(channel), false));</span>
		}
<span class="fc" id="L818">		configuration.getListenerManager().onEvent(new ServerResponseEvent(bot, code, rawResponse, parsedResponse));</span>
<span class="fc" id="L819">	}</span>

	/**
	 * Called when the mode of a channel is set. We process this in order to
	 * call the appropriate onOp, onDeop, etc method before finally calling the
	 * override-able onMode method.
	 * &lt;p&gt;
	 * Note that this method is private and is not intended to appear in the
	 * javadoc generated documentation.
	 *
	 * @param target The channel or nick that the mode operation applies to.
	 * @param mode The mode that has been set.
	 */
	public void processMode(UserHostmask userHostmask, User user, String target, String mode) {
<span class="fc bfc" id="L833" title="All 2 branches covered.">		if (configuration.getChannelPrefixes().indexOf(target.charAt(0)) &gt;= 0) {</span>
			// The mode of a channel is being changed.
<span class="fc" id="L835">			Channel channel = bot.getUserChannelDao().getChannel(target);</span>
<span class="fc" id="L836">			channel.parseMode(mode);</span>
<span class="fc" id="L837">			ImmutableList&lt;String&gt; modeParsed = ImmutableList.copyOf(StringUtils.split(mode, ' '));</span>
<span class="fc" id="L838">			PeekingIterator&lt;String&gt; params = Iterators.peekingIterator(modeParsed.iterator());</span>
			//Process modes letter by letter, grabbing paramaters as needed
<span class="fc" id="L840">			boolean adding = true;</span>
<span class="fc" id="L841">			String modeLetters = params.next();</span>
<span class="fc bfc" id="L842" title="All 2 branches covered.">			for (int i = 0; i &lt; modeLetters.length(); i++) {</span>
<span class="fc" id="L843">				char curModeChar = modeLetters.charAt(i);</span>
<span class="fc bfc" id="L844" title="All 4 branches covered.">				if (curModeChar == '+') adding = true; else if (curModeChar == '-') adding = false; else {</span>
<span class="fc" id="L845">					ChannelModeHandler modeHandler = configuration.getChannelModeHandlers().get(curModeChar);</span>
<span class="fc bfc" id="L846" title="All 2 branches covered.">					if (modeHandler != null) modeHandler.handleMode(bot, channel, userHostmask, user, params, adding, true);</span>
				}
			}
<span class="fc" id="L849">			configuration.getListenerManager().onEvent(new ModeEvent(bot, channel, userHostmask, user, mode, modeParsed));</span>
<span class="fc" id="L850">		} else {</span>
			// The mode of a user is being changed.
<span class="fc" id="L852">			UserHostmask targetHostmask = bot.getConfiguration().getBotFactory().createUserHostmask(bot, target);</span>
<span class="fc" id="L853">			User targetUser = bot.getUserChannelDao().getUser(target);</span>
<span class="fc" id="L854">			configuration.getListenerManager().onEvent(new UserModeEvent(bot, userHostmask, user, targetHostmask, targetUser, mode));</span>
		}
<span class="fc" id="L856">	}</span>

	public void processUserStatus(Channel chan, User user, String prefix) {
<span class="fc bfc" id="L859" title="All 2 branches covered.">		for (char prefixChar : prefix.toCharArray()) {</span>
<span class="fc" id="L860">			UserLevel level = UserLevel.fromSymbol(prefixChar);</span>
<span class="fc bfc" id="L861" title="All 2 branches covered.">			if (level != null) bot.getUserChannelDao().addUserToLevel(level, user, chan);</span>
		}
		//Assume here (H) if there is no G
<span class="fc bfc" id="L864" title="All 2 branches covered.">		user.setAwayMessage(prefix.contains(&quot;G&quot;) ? &quot;&quot; : null);</span>
<span class="fc" id="L865">		user.setIrcop(prefix.contains(&quot;*&quot;));</span>
<span class="fc" id="L866">	}</span>

	public User createUserIfNull(User otherUser, @NonNull UserHostmask hostmask) {
<span class="pc bpc" id="L869" title="1 of 2 branches missed.">		if (hostmask == null) {</span>
<span class="nc" id="L870">			throw new java.lang.NullPointerException(&quot;hostmask&quot;);</span>
		}
<span class="fc bfc" id="L872" title="All 2 branches covered.">		if (otherUser != null) {</span>
			//We could have fresh user data
<span class="fc" id="L874">			otherUser.updateHostmask(hostmask);</span>
<span class="fc" id="L875">			return otherUser;</span>
<span class="pc bpc" id="L876" title="1 of 2 branches missed.">		} else if (bot.getUserChannelDao().containsUser(hostmask)) throw new RuntimeException(&quot;User wasn\'t fetched but user exists in DAO. Please report this bug&quot;);</span>
<span class="fc" id="L877">		return bot.getUserChannelDao().createUser(hostmask);</span>
	}

	/**
	 * Clear out builders.
	 */
	public void close() {
<span class="fc" id="L884">		capEndSent = false;</span>
<span class="fc" id="L885">		capHandlersFinished.clear();</span>
<span class="fc" id="L886">		whoisBuilder.clear();</span>
<span class="fc" id="L887">		motdBuilder = null;</span>
<span class="fc" id="L888">		channelListRunning = false;</span>
<span class="fc" id="L889">		channelListBuilder = null;</span>
<span class="fc" id="L890">	}</span>

	protected static abstract class OpChannelModeHandler extends ChannelModeHandler {
		protected final UserLevel level;

		public OpChannelModeHandler(char mode, UserLevel level) {
<span class="fc" id="L896">			super(mode);</span>
<span class="fc" id="L897">			this.level = level;</span>
<span class="fc" id="L898">		}</span>

		@Override
		public void handleMode(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, PeekingIterator&lt;String&gt; params, boolean adding, boolean dispatchEvent) {
<span class="fc" id="L902">			String recipient = params.next();</span>
<span class="fc" id="L903">			UserHostmask recipientHostmask = bot.getConfiguration().getBotFactory().createUserHostmask(bot, recipient);</span>
<span class="fc" id="L904">			User recipientUser = null;</span>
<span class="fc bfc" id="L905" title="All 2 branches covered.">			if (bot.getUserChannelDao().containsUser(recipient)) {</span>
<span class="fc" id="L906">				recipientUser = bot.getUserChannelDao().getUser(recipient);</span>
<span class="fc bfc" id="L907" title="All 2 branches covered.">				if (adding) bot.getUserChannelDao().addUserToLevel(level, recipientUser, channel); else bot.getUserChannelDao().removeUserFromLevel(level, recipientUser, channel);</span>
			}
<span class="pc bpc" id="L909" title="1 of 2 branches missed.">			if (dispatchEvent) dispatchEvent(bot, channel, sourceHostmask, sourceUser, recipientHostmask, recipientUser, adding);</span>
<span class="fc" id="L910">		}</span>

		public abstract void dispatchEvent(PircBotX bot, Channel channel, UserHostmask sourceHostmask, User sourceUser, UserHostmask recipientHostmask, User recipientUser, boolean adding);
	}

	@java.beans.ConstructorProperties({&quot;configuration&quot;, &quot;bot&quot;})
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
<span class="nc" id="L918">	public InputParser(final Configuration configuration, final PircBotX bot) {</span>
<span class="nc" id="L919">		this.configuration = configuration;</span>
<span class="nc" id="L920">		this.bot = bot;</span>
<span class="nc" id="L921">	}</span>

	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
	public boolean isChannelListRunning() {
<span class="nc" id="L926">		return this.channelListRunning;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>